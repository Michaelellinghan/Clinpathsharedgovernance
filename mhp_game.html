<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MHP Simulation Game - Clinical Pathology</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .choice-btn { transition: all 0.2s; }
        .choice-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .choice-btn.correct { background-color: #22c55e; color: white; }
        .choice-btn.incorrect { background-color: #ef4444; color: white; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-8 flex-grow">
        <section class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-2">MHP Simulation</h1>
            <p class="text-lg text-gray-600">Make the right choices, fast!</p>
        </section>

        <div id="game-container" class="bg-white p-6 rounded-lg shadow-md max-w-4xl mx-auto">
            
            <div id="start-screen" class="text-center">
                <h2 class="text-2xl font-bold mb-4">MHP Simulation Training</h2>
                <p class="mb-6">You are the Biomedical Scientist. An MHP is about to be activated. You will be presented with a series of scenarios and must choose the correct action. You will be scored on speed and accuracy. Are you ready?</p>
                <button id="start-button" class="bg-blue-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-600">Start Simulation</button>
            </div>

            <div id="game-screen" class="hidden">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <div>
                        <h2 class="text-xl font-bold" id="scenario-title"></h2>
                        <p class="text-gray-600" id="scenario-description"></p>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold text-red-600">Time: <span id="timer"></span>s</div>
                        <div class="text-lg">Score: <span id="score">0</span></div>
                    </div>
                </div>
                
                <div id="task-container">
                    <div id="task-description" class="my-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 font-semibold text-lg"></div>
                    <div id="choices-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
                <div id="feedback" class="mt-4 h-12 text-lg font-semibold text-center"></div>
                <button id="next-stage-button" class="w-full mt-4 bg-gray-600 text-white font-bold py-3 rounded-lg hover:bg-gray-700 hidden">Next Stage</button>
            </div>
            
            <div id="end-screen" class="hidden text-center">
                 <h2 class="text-3xl font-bold mb-4">Simulation Complete!</h2>
                 <p class="text-xl mb-4">Your final score is: <span id="final-score" class="font-bold"></span></p>
                 <button id="restart-button" class="bg-blue-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-600">Play Again</button>
            </div>
        </div>

    </main>

    <div id="footer-placeholder"></div>
    <script src="js/component-loader.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const elements = {
                startScreen: document.getElementById('start-screen'),
                gameScreen: document.getElementById('game-screen'),
                endScreen: document.getElementById('end-screen'),
                startButton: document.getElementById('start-button'),
                restartButton: document.getElementById('restart-button'),
                scenarioTitle: document.getElementById('scenario-title'),
                scenarioDesc: document.getElementById('scenario-description'),
                timer: document.getElementById('timer'),
                score: document.getElementById('score'),
                taskDesc: document.getElementById('task-description'),
                choicesContainer: document.getElementById('choices-container'),
                feedback: document.getElementById('feedback'),
                nextStageButton: document.getElementById('next-stage-button'),
                finalScore: document.getElementById('final-score'),
            };

            const scenarios = [
                { title: 'Trauma MHP', description: '28 year old female, unknown identity, major trauma.', stages: [
                    { task: 'MHP Activated! What is your FIRST action?', timer: 15, choices: [{ text: 'Start thawing FFP', correct: false }, { text: 'Call the activating area', correct: true }, { text: 'Grab emergency blood', correct: false }, { text: 'Order more blood from NHSBT', correct: false }], feedback: "Correct! Communication is the first critical step." },
                    { task: 'What blood do you prepare for TRAUMA PACK 1?', timer: 20, choices: [{ text: '4x O Pos RBC, 4x FFP', correct: false }, { text: '4x O Neg RBC, 4x FFP', correct: true }, { text: '6x Group Specific RBC', correct: false }, { text: '4x O Neg RBC only', correct: false }], feedback: "Correct! Females of child-bearing age receive O Negative blood." },
                    { task: 'The patient is Group B Positive. A porter arrives for Pack 2. What do you give them?', timer: 25, choices: [{ text: '6x O Neg RBC, 4x FFP, 1x Plt', correct: false }, { text: '6x B Pos RBC only', correct: false }, { text: '6x B Pos RBC, 4x FFP, 1x Plt', correct: true }, { text: '6x O Pos RBC, 4x FFP, 1x Plt', correct: false }], feedback: "Correct! Switch to group-specific blood as soon as possible." }
                ]},
                { title: 'Obstetric MHP', description: '35 year old female, Post-Partum Haemorrhage. She is group A Positive.', stages: [
                    { task: 'MHP Activated! The midwife requests blood. What is your priority?', timer: 15, choices: [{ text: 'Issue 4 units A Pos RBC', correct: true }, { text: 'Issue Pack 1 (4 RBC, 4 FFP)', correct: false }, { text: 'Wait for coagulation results', correct: false }, { text: 'Thaw 2 units of Cryo', correct: false }], feedback: "Correct! For non-trauma, red cells are the immediate priority." },
                    { task: 'The Fibrinogen result is 0.8 g/L (critically low). What component is now most urgently needed?', timer: 20, choices: [{ text: 'More Red Cells', correct: false }, { text: 'Platelets', correct: false }, { text: 'Cryoprecipitate', correct: true }, { text: 'Fresh Frozen Plasma (FFP)', correct: false }], feedback: "Correct! Cryoprecipitate is rich in fibrinogen and vital in obstetric bleeds." },
                    { task: 'The bleed is ongoing. The team has given 6 units of red cells. What should you proactively prepare next?', timer: 20, choices: [{ text: 'More Cryoprecipitate', correct: false }, { text: 'A dose of NovoSeven', correct: false }, { text: '4 units of FFP', correct: true }, { text: 'Another unit of Platelets', correct: false }], feedback: "Correct! A 1:1 ratio of FFP to Red Cells is often targeted." }
                ]},
                 { title: 'Surgical MHP', description: '65 year old male, post-op bleed in theatres. Patient is O Positive with known Anti-K.', stages: [
                    { task: 'Theatres activate the MHP. You have a valid sample. What red cells do you select?', timer: 20, choices: [{ text: '6 units of O Positive', correct: false }, { text: '4 units of O Negative', correct: false }, { text: '6 units of K-Negative O Positive', correct: true }, { text: '6 units of K-Negative O Negative', correct: false }], feedback: "Correct! Antigen-negative blood must be selected for patients with known antibodies." },
                    { task: 'The anaesthetist calls: "The patient is still oozing. Coags are pending. What should we have?" What is your best response?', timer: 20, choices: [{ text: 'Issue 4 FFP and 1 Platelets now', correct: false }, { text: 'Wait for the lab results', correct: false }, { text: 'Liaise with the Haematology Registrar for advice', correct: true }, { text: 'Send 2 units of Cryoprecipitate', correct: false }], feedback: "Correct! The BMS role is to facilitate, not to give clinical advice. Involving the Haematology SpR is key." },
                    { task: 'Lab results: Platelets 45, PT and APTT very prolonged. What components do you anticipate being requested?', timer: 20, choices: [{ text: 'Red Cells and Cryo', correct: false }, { text: 'FFP and Platelets', correct: true }, { text: 'Platelets only', correct: false }, { text: 'FFP only', correct: false }], feedback: "Correct! Low platelets and prolonged clotting times indicate a need for FFP and Platelets." }
                ]}
            ];

            let state;

            const resetState = () => { state = { score: 0, timer: 0, timerInterval: null, currentScenario: null, currentStage: 0 }; };

            const startGame = () => {
                resetState();
                state.currentScenario = scenarios[Math.floor(Math.random() * scenarios.length)];
                elements.score.textContent = state.score;
                elements.startScreen.classList.add('hidden');
                elements.endScreen.classList.add('hidden');
                elements.gameScreen.classList.remove('hidden');
                loadStage();
            };

            const loadStage = () => {
                const stage = state.currentScenario.stages[state.currentStage];
                elements.scenarioTitle.textContent = state.currentScenario.title;
                elements.scenarioDesc.textContent = state.currentScenario.description;
                elements.taskDesc.textContent = stage.task;
                elements.feedback.textContent = '';
                elements.choicesContainer.innerHTML = '';
                elements.nextStageButton.classList.add('hidden');

                stage.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.textContent = choice.text;
                    button.className = 'choice-btn w-full p-4 bg-gray-200 rounded-lg hover:bg-gray-300 font-semibold text-left';
                    button.onclick = () => handleChoice(choice, button, stage.feedback);
                    elements.choicesContainer.appendChild(button);
                });
                
                startTimer(stage.timer);
            };

            const startTimer = (duration) => {
                clearInterval(state.timerInterval);
                state.timer = duration;
                elements.timer.textContent = state.timer;
                state.timerInterval = setInterval(() => {
                    state.timer--;
                    elements.timer.textContent = state.timer;
                    if (state.timer <= 0) {
                        clearInterval(state.timerInterval);
                        handleResult(false, 0, "Time's up! Moving to next stage...");
                    }
                }, 1000);
            };

            const handleChoice = (choice, button, feedbackText) => {
                clearInterval(state.timerInterval);
                const points = choice.correct ? state.timer : 0;
                const text = choice.correct ? feedbackText : 'Incorrect. That was not the priority action.';
                
                elements.choicesContainer.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                });
                
                button.classList.add(choice.correct ? 'correct' : 'incorrect');

                handleResult(choice.correct, points, text);
            };

            const handleResult = (correct, points, text) => {
                if (correct) {
                    state.score += points;
                    elements.score.textContent = state.score;
                    elements.feedback.className = 'mt-4 h-12 text-lg font-semibold text-center text-green-600';
                } else {
                    elements.feedback.className = 'mt-4 h-12 text-lg font-semibold text-center text-red-600';
                }
                elements.feedback.textContent = text;
                elements.nextStageButton.classList.remove('hidden');
            };

            const nextStage = () => {
                state.currentStage++;
                if (state.currentStage >= state.currentScenario.stages.length) {
                    endGame();
                } else {
                    loadStage();
                }
            };

            const endGame = () => {
                elements.gameScreen.classList.add('hidden');
                elements.endScreen.classList.remove('hidden');
                elements.finalScore.textContent = state.score;
            };

            elements.startButton.addEventListener('click', startGame);
            elements.restartButton.addEventListener('click', startGame);
            elements.nextStageButton.addEventListener('click', nextStage);
        });
    </script>
</body>
</html>
