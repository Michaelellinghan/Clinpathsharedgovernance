<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antibody Identification Challenge - Clinical Pathology</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .panel-table { border-collapse: collapse; white-space: nowrap; }
        .panel-table th, .panel-table td { border: 1px solid #d1d5db; padding: 0.25rem 0.5rem; text-align: center; position: relative; }
        .panel-table th { background-color: #f3f4f6; }
        .antigen-header { cursor: pointer; user-select: none; }
        .line-through::after {
            content: '';
            position: absolute;
            top: -1px;
            left: 50%;
            width: 2px;
            height: calc(100% + 2px);
            background-color: rgba(239, 68, 68, 0.6);
            transform: translateX(-50%);
            pointer-events: none;
        }
        .reaction-cell { font-weight: bold; }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-8 flex-grow">
        <section class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-2">Antibody Identification Challenge</h1>
            <p class="text-lg text-gray-600">Use your skills and tools to solve the antibody puzzle.</p>
        </section>

        <div class="bg-white p-6 rounded-lg shadow-md max-w-full mx-auto">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <div>
                    <h2 class="text-2xl font-bold">Case File: <span id="case-name"></span></h2>
                    <p id="feedback" class="mt-1 h-6 text-lg font-semibold text-gray-500">A new case is ready for investigation.</p>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <button id="tutorial-button" class="bg-blue-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors text-sm md:text-base"><i class="fas fa-question-circle mr-1"></i>How to Investigate</button>
                    <div class="text-lg font-bold">Score: <span id="score">0</span></div>
                </div>
            </div>

            <div class="flex flex-wrap gap-4 my-4">
                <button id="screen-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg"><i class="fas fa-vials mr-2"></i>View Screen Cells</button>
                <button id="enzyme-button" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-4 rounded-lg"><i class="fas fa-magic mr-2"></i>Run Enzyme Panel</button>
            </div>
            
            <div class="overflow-x-auto">
                <table id="panel-table" class="panel-table w-full text-sm"></table>
            </div>

            <div class="mt-6 flex flex-col md:flex-row items-center justify-center gap-4">
                <label for="answer-select" class="font-bold text-lg">Final Identification:</label>
                <select id="answer-select" class="p-2 border border-gray-300 rounded-lg"></select>
                <button id="submit-answer" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition-colors">Submit Report</button>
                 <button id="next-case" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors hidden">Next Case</button>
            </div>
        </div>
        
        <section class="text-center mt-12">
            <a href="games.html" class="bg-gray-800 text-white font-bold py-3 px-8 rounded-full hover:bg-gray-700 transition duration-300">
                <i class="fas fa-arrow-left mr-2"></i>Back to Games
            </a>
        </section>
    </main>
    
    <div id="tutorial-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        </div>
    <div id="screen-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        </div>

    <div id="footer-placeholder"></div>
    <script src="js/component-loader.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const panelAntigens = {
                'Rh-hr': ['D', 'C', 'E', 'c', 'e'], 'Kell': ['K', 'k'], 'Duffy': ['Fya', 'Fyb'],
                'Kidd': ['Jka', 'Jkb'], 'MNS': ['M', 'N', 'S', 's'], 'P': ['P1'], 'Lewis': ['Lea', 'Leb']
            };
            const panelAntigensList = [].concat(...Object.values(panelAntigens));
            const panelCells = [
                { donor: 'R1R1', profile: ['+', '+', '0', '0', '+',  '0', '+',  '+', '0',  '+', '0',  '+', '0', '+', '0',  '+', '0', '+'] },
                { donor: 'R2R2', profile: ['+', '0', '+', '+', '0',  '0', '+',  '0', '+',  '0', '+',  '0', '+', '0', '+',  '+', '+', '0'] },
                { donor: 'rr',   profile: ['0', '0', '0', '+', '+',  '0', '+',  '+', '+',  '+', '+',  '+', '+', '+', '+',  '+', '0', '+'] },
                { donor: 'rr',   profile: ['0', '0', '0', '+', '+',  '+', '+',  '0', '+',  '0', '+',  '+', '0', '0', '+',  '0', '+', '0'] },
                { donor: 'R1r',  profile: ['+', '+', '0', '+', '+',  '0', '+',  '+', '+',  '+', '0',  '0', '+', '0', '+',  '0', '0', '+'] },
                { donor: 'R2r',  profile: ['+', '0', '+', '+', '+',  '0', '+',  '0', '+',  '+', '+',  '+', '0', '+', '+',  '0', '+', '0'] },
                { donor: 'r\'r',  profile: ['0', '+', '0', '+', '+',  '0', '+',  '+', '0',  '+', '0',  '0', '+', '+', '0',  '+', '+', '0'] },
                { donor: 'r"r',  profile: ['0', '0', '+', '+', '+',  '0', '+',  '0', '+',  '0', '+',  '+', '0', '0', '+',  '0', '+', '+'] },
            ];
            
            const gameCases = [
                { name: 'Easy Case 1', screen: { I: '2+', II: '0', III: '2+' }, iat: ['0', '0', '0', '2+', '0', '0', '0', '0'], enzyme: ['0', '0', '0', '2+', '0', '0', '0', '0'], auto: '0', solution: 'Anti-K' },
                { name: 'Easy Case 2', screen: { I: '0', II: '3+', III: '3+' }, iat: ['0', '3+', '3+', '0', '0', '3+', '0', '3+'], enzyme: ['0', '4+', '4+', '0', '0', '4+', '0', '4+'], auto: '0', solution: 'Anti-E' },
                { name: 'Medium Case 1', screen: { I: '3+', II: '3+', III: '0' }, iat: ['3+', '0', '0', '0', '3+', '0', '3+', '0'], enzyme: ['4+', '0', '0', '0', '4+', '0', '4+', '0'], auto: '0', solution: 'Anti-C' },
                { name: 'Medium Case 2', screen: { I: '2+', II: '0', III: '2+' }, iat: ['2+', '0', '2+', '2+', '2+', '2+', '2+', '2+'], enzyme: ['0', '0', '0', '2+', '0', '2+', '0', '0'], auto: '0', solution: 'Anti-M' },
                { name: 'Hard Case 1 (Multiple Abs)', screen: { I: '3+', II: '3+', III: '3+' }, iat: ['3+', '3+', '3+', '2+', '3+', '3+', '3+', '3+'], enzyme: ['3+', '3+', '3+', '0', '3+', '3+', '3+', '3+'], auto: '0', solution: 'Anti-E and Anti-Fya' },
                { name: 'Hard Case 2 (Autoantibody)', screen: { I: '1+', II: '1+', III: '1+' }, iat: ['1+', '1+', '1+', '1+', '1+', '1+', '1+', '1+'], enzyme: ['2+', '2+', '2+', '2+', '2+', '2+', '2+', '2+'], auto: '1+', solution: 'Autoantibody' },
                { name: 'Hard Case 3 (Multiple Abs)', screen: { I: '3+', II: '3+', III: '3+' }, iat: ['3+', '3+', '0', '2+', '3+', '3+', '2+', '0'], enzyme: ['4+', '4+', '0', '3+', '4+', '4+', '3+', '0'], auto: '0', solution: 'Anti-c and Anti-K' },
            ];

            // --- ELEMENTS & STATE ---
            const elements = {
                table: document.getElementById('panel-table'),
                answerSelect: document.getElementById('answer-select'),
                submitButton: document.getElementById('submit-answer'),
                nextCaseButton: document.getElementById('next-case'),
                feedbackEl: document.getElementById('feedback'),
                scoreEl: document.getElementById('score'),
                caseNameEl: document.getElementById('case-name'),
                tutorialButton: document.getElementById('tutorial-button'),
                closeTutorialButton: document.getElementById('close-tutorial'),
                tutorialModal: document.getElementById('tutorial-modal'),
                screenButton: document.getElementById('screen-button'),
                closeScreenButton: document.getElementById('close-screen'),
                screenModal: document.getElementById('screen-modal'),
                enzymeButton: document.getElementById('enzyme-button'),
            };
            
            let state = { currentCaseIndex: 0, score: 0 };

            // --- FUNCTIONS ---
            function renderPanelStructure() {
                elements.table.innerHTML = '';
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');
                
                // Top Header Row (Blood Systems)
                const topHeaderRow = document.createElement('tr');
                topHeaderRow.innerHTML = '<th>Donor</th>'; // Placeholder for Donor column
                for (const system in panelAntigens) {
                    topHeaderRow.innerHTML += `<th colspan="${panelAntigens[system].length}">${system}</th>`;
                }
                topHeaderRow.innerHTML += '<th colspan="2">Reactions</th>';
                thead.appendChild(topHeaderRow);

                // Bottom Header Row (Antigens)
                const bottomHeaderRow = document.createElement('tr');
                bottomHeaderRow.innerHTML = '<th></th>'; // Placeholder for Donor column
                panelAntigensList.forEach(ag => {
                    bottomHeaderRow.innerHTML += `<th class="antigen-header" data-antigen-index="${panelAntigensList.indexOf(ag)}">${ag.replace('a','<sup>a</sup>').replace('b','<sup>b</sup>')}</th>`;
                });
                bottomHeaderRow.innerHTML += '<th>IAT</th><th id="enzyme-header" class="hidden">Enzyme</th>';
                thead.appendChild(bottomHeaderRow);

                elements.table.appendChild(thead);
                elements.table.appendChild(tbody);
            }

            function loadCase(caseIndex) {
                const caseData = gameCases[caseIndex];
                const tbody = elements.table.querySelector('tbody');
                tbody.innerHTML = '';

                panelCells.forEach((cell, index) => {
                    const row = document.createElement('tr');
                    let rowHtml = `<td>${cell.donor}</td>`;
                    cell.profile.forEach((antigenResult, antigenIndex) => {
                        rowHtml += `<td data-col-index="${antigenIndex}">${antigenResult}</td>`;
                    });
                    rowHtml += `<td class="reaction-cell">${caseData.iat[index] || '0'}</td>`;
                    rowHtml += `<td class="reaction-cell hidden" data-enzyme-result="true">${caseData.enzyme[index] || '0'}</td>`;
                    row.innerHTML = rowHtml;
                    tbody.appendChild(row);
                });
                
                const autoRow = document.createElement('tr');
                autoRow.innerHTML = `<td class="font-bold">Auto</td><td colspan="${panelAntigensList.length}"></td><td class="reaction-cell">${caseData.auto}</td><td class="reaction-cell hidden" data-enzyme-result="true">${caseData.auto}</td>`;
                tbody.appendChild(autoRow);

                // Update UI
                elements.caseNameEl.textContent = caseData.name;
                document.getElementById('screen-I').textContent = caseData.screen.I;
                document.getElementById('screen-II').textContent = caseData.screen.II;
                document.getElementById('screen-III').textContent = caseData.screen.III;
                elements.feedbackEl.textContent = 'A new case is ready for investigation.';
                elements.feedbackEl.className = 'mt-1 h-6 text-lg font-semibold text-gray-500';
                elements.submitButton.classList.remove('hidden');
                elements.nextCaseButton.classList.add('hidden');
                elements.answerSelect.disabled = false;
                elements.enzymeButton.disabled = caseData.enzyme.length === 0;
                
                document.querySelectorAll('.antigen-header, td[data-col-index]').forEach(el => el.classList.remove('line-through'));
                document.getElementById('enzyme-header').classList.add('hidden');
                document.querySelectorAll('[data-enzyme-result]').forEach(el => el.classList.add('hidden'));
            }

            function populateAnswerOptions() {
                const allAntibodies = ['Anti-D', 'Anti-C', 'Anti-E', 'Anti-c', 'Anti-e', 'Anti-K', 'Anti-k', 'Anti-Fya', 'Anti-Fyb', 'Anti-Jka', 'Anti-Jkb', 'Anti-M', 'Anti-N', 'Anti-S', 'Anti-s', 'Anti-P1', 'Anti-Lea', 'Anti-Leb', 'Autoantibody', 'Anti-E and Anti-Fya'];
                elements.answerSelect.innerHTML = '<option value="">Select Antibody...</option>';
                allAntibodies.forEach(ab => {
                    const option = document.createElement('option');
                    option.value = ab;
                    option.textContent = ab.replace('a', 'a').replace('b', 'b');
                    elements.answerSelect.appendChild(option);
                });
            }

            function checkAnswer() {
                const selectedAnswer = elements.answerSelect.value;
                const correctAnswer = gameCases[state.currentCaseIndex].solution;

                if (selectedAnswer === correctAnswer) {
                    elements.feedbackEl.textContent = 'Correct! Excellent work.';
                    elements.feedbackEl.className = 'mt-1 h-6 text-lg font-semibold text-green-600';
                    state.score += 10;
                    elements.scoreEl.textContent = state.score;
                } else {
                    elements.feedbackEl.textContent = `Not quite. The correct answer is ${correctAnswer}.`;
                    elements.feedbackEl.className = 'mt-1 h-6 text-lg font-semibold text-red-600';
                }
                
                elements.submitButton.classList.add('hidden');
                elements.nextCaseButton.classList.remove('hidden');
                elements.answerSelect.disabled = true;
            }
            
            function toggleExclusion(columnIndex) {
                const th = document.querySelector(`.antigen-header[data-antigen-index="${columnIndex}"]`);
                const tds = document.querySelectorAll(`td[data-col-index="${columnIndex}"]`);
                th.classList.toggle('line-through');
                tds.forEach(td => td.classList.toggle('line-through'));
            }

            // --- EVENT LISTENERS ---
            elements.table.addEventListener('click', (e) => {
                const header = e.target.closest('.antigen-header');
                if (header) {
                    toggleExclusion(header.dataset.antigenIndex);
                }
            });
            
            elements.submitButton.addEventListener('click', checkAnswer);
            
            elements.nextCaseButton.addEventListener('click', () => {
                state.currentCaseIndex = (state.currentCaseIndex + 1) % gameCases.length;
                loadCase(state.currentCaseIndex);
            });
            
            elements.enzymeButton.addEventListener('click', () => {
                if(!elements.enzymeButton.disabled) {
                    document.getElementById('enzyme-header').classList.remove('hidden');
                    document.querySelectorAll('[data-enzyme-result]').forEach(el => el.classList.remove('hidden'));
                    elements.enzymeButton.disabled = true;
                }
            });

            elements.tutorialButton.addEventListener('click', () => elements.tutorialModal.classList.add('active'));
            elements.closeTutorialButton.addEventListener('click', () => elements.tutorialModal.classList.remove('active'));
            elements.screenButton.addEventListener('click', () => elements.screenModal.classList.add('active'));
            elements.closeScreenButton.addEventListener('click', () => elements.screenModal.classList.remove('active'));

            // --- INITIALIZATION ---
            renderPanelStructure();
            populateAnswerOptions();
            loadCase(state.currentCaseIndex);
        });
    </script>
</body>
</html>
