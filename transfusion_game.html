<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antibody Identification Challenge - Clinical Pathology</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .panel-table { border-collapse: collapse; white-space: nowrap; }
        .panel-table th, .panel-table td { border: 1px solid #d1d5db; padding: 0.25rem 0.5rem; text-align: center; position: relative; }
        .panel-table th { background-color: #f3f4f6; }
        .antigen-header { cursor: pointer; user-select: none; }
        .line-through::after {
            content: '';
            position: absolute;
            top: -1px;
            left: 50%;
            width: 2px;
            height: calc(100% + 2px);
            background-color: rgba(239, 68, 68, 0.6);
            transform: translateX(-50%);
            pointer-events: none;
        }
        .reaction-cell { font-weight: bold; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .answer-checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-8 flex-grow">
        <section class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-2">Antibody Identification Challenge</h1>
            <p class="text-lg text-gray-600">Use your skills and tools to solve the antibody puzzle.</p>
        </section>

        <!-- Case Selection Controls -->
        <div class="bg-white p-4 rounded-lg shadow-md max-w-full mx-auto mb-6">
            <div class="flex flex-wrap items-center justify-center gap-4">
                <label for="case-select" class="font-bold text-lg">Select a Case:</label>
                <select id="case-select" class="p-2 border border-gray-300 rounded-lg"></select>
                <button id="random-case-button" class="bg-purple-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-600 transition-colors">
                    <i class="fas fa-random mr-2"></i>Random Case
                </button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md max-w-full mx-auto">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <div>
                    <h2 class="text-2xl font-bold">Case File: <span id="case-number"></span></h2>
                    <p id="clinical-details" class="text-md text-gray-600 font-medium"></p>
                    <p id="feedback" class="mt-1 h-6 text-lg font-semibold text-gray-500">A new case is ready for investigation.</p>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <button id="tutorial-button" class="bg-blue-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors text-sm md:text-base"><i class="fas fa-question-circle mr-1"></i>How to Investigate</button>
                    <div class="text-lg font-bold">Score: <span id="score">0</span></div>
                </div>
            </div>

            <div class="flex flex-wrap gap-4 my-4">
                <button id="screen-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg"><i class="fas fa-vials mr-2"></i>View Screen Cells</button>
                <button id="enzyme-button" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-4 rounded-lg"><i class="fas fa-magic mr-2"></i>Run Enzyme Panel</button>
            </div>
            
            <div class="overflow-x-auto">
                <table id="panel-table" class="panel-table w-full text-sm"></table>
            </div>

            <div class="mt-6">
                <label class="font-bold text-lg">Final Identification:</label>
                <div id="answer-checkboxes" class="answer-checkbox-grid mt-2"></div>
                <div class="mt-4 flex items-center">
                    <input type="checkbox" id="cw-checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="cw-checkbox" class="ml-2 font-semibold text-gray-700">Cannot exclude Cʷ</label>
                </div>
            </div>

            <div class="mt-6 flex items-center justify-center gap-4">
                <button id="submit-answer" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition-colors">Submit Report</button>
                <button id="next-case" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors hidden">Next Case</button>
            </div>
             <div id="notes-container" class="mt-6 hidden">
                <h3 class="font-bold text-lg">Case Notes:</h3>
                <p id="case-notes" class="p-3 bg-gray-100 rounded-md"></p>
            </div>
        </div>
        
        <section class="text-center mt-12">
            <a href="games.html" class="bg-gray-800 text-white font-bold py-3 px-8 rounded-full hover:bg-gray-700 transition duration-300">
                <i class="fas fa-arrow-left mr-2"></i>Back to Games
            </a>
        </section>
    </main>
    
    <div id="tutorial-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
            <h3 class="text-2xl font-bold mb-4">How to Investigate</h3>
            <ul class="list-disc list-inside space-y-2 text-left">
                <li>Check the screen cell results to see which cells are positive.</li>
                <li>Look at the main panel and find cells with matching positive and negative reactions.</li>
                <li>Click the antigen names at the top of the table to "cross out" antigens that don't fit the pattern.</li>
                <li>Use the enzyme panel to confirm or eliminate possibilities (e.g., Duffy & MNS antigens are destroyed by enzymes).</li>
                <li>Select all antibodies you believe are present using the checkboxes.</li>
                <li>If Cʷ is a possibility you cannot rule out, tick the Cʷ checkbox.</li>
                <li>Submit your report to see the answer and notes.</li>
            </ul>
            <button id="close-tutorial" class="mt-6 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Close</button>
        </div>
    </div>
    <div id="screen-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-4xl w-full text-center overflow-x-auto">
            <h3 class="text-2xl font-bold mb-4">Screening Cell Results & Antigram</h3>
            <table class="w-full text-center panel-table text-sm">
                <thead>
                    <tr><th class="p-2 border"></th><th class="p-2 border">Screen Cell I</th><th class="p-2 border">Screen Cell II</th><th class="p-2 border">Screen Cell III</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="p-2 border font-bold text-left">Reaction Strength</td>
                        <td class="p-2 border font-bold text-2xl" id="screen-I"></td>
                        <td class="p-2 border font-bold text-2xl" id="screen-II"></td>
                        <td class="p-2 border font-bold text-2xl" id="screen-III"></td>
                    </tr>
                    <tr class="bg-gray-100"><td colspan="4" class="p-2 border font-bold text-left">Antigen Profile</td></tr>
                </tbody>
                <tbody id="screen-antigram"></tbody>
            </table>
            <button id="close-screen" class="mt-6 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Close</button>
        </div>
    </div>

    <div id="footer-placeholder"></div>
    <script src="js/component-loader.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const panelAntigens = {
                'Rh': ['D', 'C', 'E', 'c', 'e', 'Cʷ'],
                'Kell': ['K', 'k', 'Kpᵃ', 'Kpᵇ', 'Jsᵃ', 'Jsᵇ'],
                'Duffy': ['Fyᵃ', 'Fyᵇ'],
                'Kidd': ['Jkᵃ', 'Jkᵇ'],
                'Lewis': ['Leᵃ', 'Leᵇ'],
                'P': ['P1'],
                'MNS': ['M', 'N', 'S', 's'],
                'Lutheran': ['Luᵃ', 'Luᵇ']
            };
            const panelAntigensList = [].concat(...Object.values(panelAntigens));
            
            const panelCells = [
                // Data meticulously transcribed from the final user-provided image and text
                //       D  C  E  c  e  Cʷ   K  k  Kpᵃ Kpᵇ Jsᵃ Jsᵇ   Fyᵃ Fyᵇ   Jkᵃ Jkᵇ   Leᵃ Leᵇ   P1   M  N  S  s   Luᵃ Luᵇ
                { donor: 'R1WR1', profile: ['+', '+', '0', '0', '+', '+', '0', '+', '0', '+', 'nt', 'nt', '+', '0', '+', '0', '0', '+', '+', '+', '0', '0', '+', '0', '+'] }, // Cell 1
                { donor: 'R1R1',  profile: ['+', '+', '0', '0', '+', '0', '+', '+', '0', '+', 'nt', 'nt', '0', '+', '+', '+', '+', '0', '0', '+', '+', '+', '0', '0', '+'] }, // Cell 2
                { donor: 'R2R2',  profile: ['+', '0', '+', '+', '0', '0', '0', '+', '0', '+', 'nt', 'nt', '0', '+', '0', '+', '0', '0', '+', '+', '+', '0', '+', '0', '+'] }, // Cell 3
                { donor: 'r\'r',   profile: ['0', '+', '0', '+', '+', '0', '0', '+', '0', '+', 'nt', 'nt', '0', '0', '+', '0', '0', '+', '0', '0', '+', '0', '+', '0', '+'] }, // Cell 4
                { donor: 'r\"r',  profile: ['0', '0', '+', '+', '+', '0', '0', '+', '0', '+', 'nt', 'nt', '+', '0', '+', '0', '+', '0', '+', '0', '+', '+', '+', '+', '+'] }, // Cell 5
                { donor: 'rr',    profile: ['0', '0', '0', '+', '+', '0', '+', '+', '0', '+', 'nt', 'nt', '+', '+', '0', '+', '+', '0', '+', '+', '0', '+', '0', '0', '+'] }, // Cell 6
                { donor: 'rr',    profile: ['0', '0', '0', '+', '+', '0', '0', '+', '+', '+', 'nt', 'nt', '0', '+', '0', '+', '0', '+', '0', '+', '+', '0', '+', '0', '+'] }, // Cell 7
                { donor: 'r0R',   profile: ['+', '0', '0', '+', '+', '0', '0', '+', '0', '+', 'nt', 'nt', '0', '+', '+', '+', '0', '+', '+', '+', '+', '+', '0', '0', '+'] }, // Cell 8
                { donor: 'rr',    profile: ['0', '0', '0', '+', '+', '0', '0', '+', '0', '+', 'nt', 'nt', '+', '+', '0', '+', '+', '0', '+', '0', '+', '0', '0', '0', '+'] }, // Cell 9
                { donor: 'rr',    profile: ['0', '0', '0', '+', '+', '0', '0', '+', '0', '+', 'nt', 'nt', '+', '0', '+', '0', '0', '+', '+', '+', '0', '0', '+', '0', '+'] }, // Cell 10
                { donor: 'rr',    profile: ['0', '0', '0', '+', '+', '0', '0', '+', '0', '+', 'nt', 'nt', '0', '0', '+', '0', '0', '0', '+', '0', '+', '0', '+', '+', '+'] }  // Cell 11
            ];

            const gameCases = [
                { clinicalDetails: '34 y/o female, pre-operative assessment for hysterectomy.', screen: { I: '0', II: '3+', III: '0' }, auto: '0', iat: ['0', '0', '3+', '0', '3+', '0', '0', '0', '0', '0', '0'], enzyme: ['0', '0', '4+', '0', '4+', '0', '0', '0', '0', '0', '0'], solution: ['Anti-E'], notes: 'A straightforward Anti-E. The reaction pattern perfectly matches the E-positive cells (3 and 5). Reactions are enhanced by enzyme treatment, characteristic of the Rh system.' },
                { clinicalDetails: '68 y/o male, history of multiple transfusions, now needing 2 units for anaemia.', screen: { I: '0', II: '2+', III: '0' }, auto: '0', iat: ['0', '2+', '0', '0', '0', '2+', '0', '0', '0', '0', '0'], enzyme: ['0', '2+', '0', '0', '0', '2+', '0', '0', '0', '0', '0'], solution: ['Anti-K'], notes: 'A classic Anti-K. The reactions are positive only with the K-positive cells (2 and 6). Kell system antigens are not affected by ficin enzyme treatment.' },
                { clinicalDetails: '28 y/o female, antenatal booking sample.', screen: { I: '2+', II: '0', III: '0' }, auto: '0', iat: ['2+', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'], enzyme: ['3+', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'], solution: ['Anti-Cʷ'], notes: 'A clear Anti-Cʷ, reacting only with the Cʷ positive cell (1). As part of the Rh system, reactions are enhanced by enzyme treatment.' },
                { clinicalDetails: '45 y/o male, pre-operative assessment for knee replacement.', screen: { I: '2+', II: '0', III: '2+' }, auto: '0', iat: ['2+', '0', '0', '0', '2+', '2+', '0', '0', '2+', '2+', '0'], enzyme: ['0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'], solution: ['Anti-Fyᵃ'], notes: 'The reaction pattern matches all Fyᵃ-positive cells (1, 5, 6, 9, 10). The identification is confirmed by the enzyme panel, where all reactions become negative because the Fyᵃ antigen is destroyed by enzymes.' },
                { clinicalDetails: '72 y/o female, requires transfusion for GI bleed.', screen: { I: '3+', II: '3+', III: '0' }, auto: '0', iat: ['3+', '3+', '0', '3+', '0', '0', '0', '0', '0', '0', '0'], enzyme: ['4+', '4+', '0', '4+', '0', '0', '0', '0', '0', '0', '0'], solution: ['Anti-C'], notes: 'A classic Anti-C pattern, reacting with all C-positive cells (1, 2, 4). Reactions are enhanced by enzyme treatment.' },
                { clinicalDetails: '55 y/o male with sickle cell disease, routine group and screen.', screen: { I: '0', II: '2+', III: '2+' }, auto: '0', iat: ['0', '2+', '2+', '0', '0', '2+', '2+', '2+', '2+', '0', '0'], enzyme: ['0', '3+', '3+', '0', '0', '3+', '3+', '3+', '3+', '0', '0'], solution: ['Anti-Jkᵇ'], notes: 'This pattern matches all Jkᵇ-positive cells. Kidd system antibodies are enhanced by enzyme treatment, as seen here.' },
                { clinicalDetails: '61 y/o female, previous transfusion 1 year ago, now needs blood for surgery.', screen: { I: '3+', II: '3+', III: '3+' }, auto: '0', iat: ['3+', '0', '3+', '3+', '3+', '0', '3+', '3+', '0', '3+', '3+'], enzyme: ['3+', '0', '3+', '3+', '3+', '0', '3+', '3+', '0', '3+', '3+'], solution: ['Anti-s'], notes: 'This antibody reacts with all cells except for cells 2, 6, and 9, which are the only s-negative cells on the panel. The reactivity of S/s antigens with enzymes can be variable.' },
                { clinicalDetails: '82 y/o male, routine pre-admission testing.', screen: { I: '1+', II: '1+', III: '1+' }, auto: '0', iat: ['1+', '0', '1+', '0', '1+', '1+', '1+', '1+', '0', '1+', '1+'], enzyme: ['2+', '0', '2+', '0', '2+', '2+', '2+', '2+', '0', '2+', '2+'], solution: ['Anti-P1'], notes: 'Reacts with all P1-positive cells. Anti-P1 is a common, naturally occurring IgM antibody that is not considered clinically significant. It is enhanced by enzyme treatment.' },
                { clinicalDetails: '22 y/o female, first pregnancy, 28-week sample.', screen: { I: '2+', II: '2+', III: '2+' }, auto: '0', iat: ['2+', '2+', '2+', '0', '0', '0', '2+', '2+', '0', '2+', '0'], enzyme: ['0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'], solution: ['Anti-M'], notes: 'This antibody reacts with all M-positive cells. MNS system antigens are typically destroyed by enzyme treatment, which is a key identifying feature.' },
                { clinicalDetails: '40 y/o male, trauma patient, major haemorrhage protocol activated.', screen: { I: '3+', II: '3+', III: '3+' }, auto: '0', iat: ['3+', '3+', '3+', '0', '0', '0', '0', '3+', '0', '0', '0'], enzyme: ['4+', '4+', '4+', '0', '0', '0', '0', '4+', '0', '0', '0'], solution: ['Anti-D'], notes: 'A clear Anti-D, reacting with all D-positive cells (1, 2, 3, 8). Enhanced by enzyme.' },
                { clinicalDetails: '76 y/o female, multiple antibodies in history, pre-op for hip surgery.', screen: { I: '3+', II: '3+', III: '3+' }, auto: '0', iat: ['3+', '3+', '3+', '3+', '3+', '3+', '3+', '3+', '3+', '0', '0'], enzyme: ['4+', '4+', '4+', '4+', '4+', '4+', '4+', '4+', '4+', '0', '0'], solution: ['Anti-c', 'Anti-Jkᵃ'], notes: 'A complex case. The pattern doesn\'t fit a single antibody. The negative reactions with cells 10 and 11 are the key. The reactions match all cells that are c-positive OR Jkᵃ-positive. Both antibodies can be enhanced by enzyme.' },
                { clinicalDetails: '31 y/o female, post-partum haemorrhage.', screen: { I: '3+', II: '2+', III: '0' }, auto: '0', iat: ['3+', '2+', '0', '0', '2+', '2+', '0', '0', '2+', '2+', '0'], enzyme: ['0', '2+', '0', '0', '0', '2+', '0', '0', '0', '0', '0'], solution: ['Anti-Fyᵃ', 'Anti-K'], notes: 'The enzyme panel is critical here. After enzyme treatment, the Fyᵃ reactions are destroyed, leaving behind reactions that perfectly match the K-positive cells (2 and 6). The remaining reactions in the IAT can then be attributed to Anti-Fyᵃ.' },
                { clinicalDetails: '67 y/o male, known haematology patient with pancytopenia.', screen: { I: '3+', II: '3+', III: '3+' }, auto: '0', iat: ['3+', '3+', '3+', '3+', '3+', '0', '0', '3+', '0', '0', '0'], enzyme: ['4+', '4+', '4+', '4+', '4+', '0', '0', '4+', '0', '0', '0'], solution: ['Anti-D', 'Anti-c'], notes: 'This pattern is consistent with Anti-D and Anti-c. All D-positive or c-positive cells are reacting. The only negative cells (6, 9) are D-negative and c-negative. Both are Rh antibodies and are enhanced by enzyme.' },
                { clinicalDetails: '29 y/o female, 2nd pregnancy, history of Anti-Fyᵃ.', screen: { I: '3+', II: '3+', III: '3+' }, auto: '0', iat: ['3+', '0', '3+', '0', '3+', '2+', '0', '0', '2+', '2+', '0'], enzyme: ['0', '0', '4+', '0', '4+', '0', '0', '0', '0', '0', '0'], solution: ['Anti-Fyᵃ', 'Anti-E'], notes: 'Another case solved by the enzyme panel. The IAT is complex. After enzyme treatment, the Fyᵃ reactions disappear, leaving a clear Anti-E pattern against cells 3 and 5. The remaining IAT reactions fit Anti-Fyᵃ.' },
                { clinicalDetails: '78 y/o male, history of multiple myeloma.', screen: { I: '3+', II: '3+', III: '3+' }, auto: '0', iat: ['3+', '3+', '3+', '3+', '3+', '3+', '3+', '3+', '3+', '3+', '3+'], enzyme: ['4+', '4+', '4+', '4+', '4+', '4+', '4+', '4+', '4+', '4+', '4+'], solution: ['Anti-e', 'Anti-Jkᵃ'], notes: 'This combination results in pan-reactivity because every cell in the panel is positive for either e or Jkᵃ. Both antibodies are enhanced by enzyme. This would require a challenging workup with selected cells to identify.' },
                { clinicalDetails: '71 y/o female with autoimmune haemolytic anaemia.', screen: { I: '1+', II: '1+', III: '1+' }, auto: '1+', iat: ['1+', '1+', '1+', '1+', '1+', '1+', '1+', '1+', '1+', '1+', '1+'], enzyme: ['2+', '2+', '2+', '2+', '2+', '2+', '2+', '2+', '2+', '2+', '2+'], solution: ['Autoantibody'], notes: 'All panel cells and the auto-control are positive with roughly equal strength. This pan-reactivity with a positive auto-control indicates a warm autoantibody. Adsorption techniques would be needed to check for underlying alloantibodies.' },
                { clinicalDetails: '33 y/o female, antenatal sample, previous Anti-C.', screen: { I: '3+', II: '1+', III: '0' }, auto: '0', iat: ['3+', '1+', '0', '1+', '0', '0', '0', '0', '0', '0', '0'], enzyme: ['4+', '2+', '0', '2+', '0', '0', '0', '0', '0', '0', '0'], solution: ['Anti-C'], notes: 'This is a classic Anti-C showing dosage. The reactions are stronger with cells from donors presumed homozygous (C+c-), like cell 1 (3+), compared to cells from heterozygous donors (C+c+), like cells 2 and 4 (1+).' },
                { clinicalDetails: '25 y/o male, request from A&E.', screen: { I: '2+', II: '0', III: '0' }, auto: '0', iat: ['0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'], enzyme: ['0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'], solution: [], notes: 'The screen is positive but the panel is negative. This suggests the patient has an antibody to a low-frequency antigen that was present on screening cell I but is not present on any of the 11 panel cells.' },
                { clinicalDetails: '88 y/o female, long-term hospital inpatient.', screen: { I: '2+', II: '2+', III: '2+' }, auto: '0', iat: ['2+', '2+', '2+', '2+', '2+', '2+', '2+', '2+', '2+', '2+', '2+'], enzyme: ['2+', '2+', '2+', '2+', '2+', '2+', '2+', '2+', '2+', '2+', '2+'], solution: [], notes: 'The panel is pan-reactive, but the auto-control is negative. This strongly suggests an antibody to a high-frequency antigen (an antigen present on almost all red cells). This would require referral for testing against a panel of rare antigen-negative cells to identify.' },
                { clinicalDetails: '79 y/o male with a cold and cough.', screen: { I: '1+', II: '1+', III: '1+' }, auto: '1+', iat: ['w', 'w', 'w', 'w', 'w', 'w', 'w', 'w', 'w', 'w', 'w'], enzyme: ['1+', '1+', '1+', '1+', '1+', '1+', '1+', '1+', '1+', '1+', '1+'], solution: ['Autoantibody'], notes: 'Weak, fuzzy reactions in the IAT with a positive auto-control, which become stronger with enzymes, can be indicative of a cold autoantibody breaking through and reacting at 37°C. Pre-warming techniques would be required to rule out underlying alloantibodies.' },
                { clinicalDetails: '38 y/o female, pre-op for cholecystectomy.', screen: { I: '0', II: '0', III: '3+' }, auto: '0', iat: ['0', '0', '3+', '0', '3+', '0', '0', '3+', '0', '0', '0'], enzyme: ['0', '0', 'w', '0', 'w', '0', '0', 'w', '0', '0', '0'], solution: ['Anti-S'], notes: 'This antibody reacts with all S-positive cells (3, 5, 8). The S antigen is known to have variable sensitivity to enzymes, often showing weakened (w) reactions but not always being completely destroyed.' },
                { clinicalDetails: '48 y/o male, transfusion required for anaemia.', screen: { I: '2+', II: '2+', III: '0' }, auto: '0', iat: ['2+', '2+', '0', '2+', '2+', '0', '0', '2+', '0', '2+', '2+'], enzyme: ['3+', '3+', '0', '3+', '3+', '0', '0', '3+', '0', '3+', '3+'], solution: ['Anti-Jkᵃ'], notes: 'This pattern matches all Jkᵃ-positive cells. Kidd antibodies are notoriously difficult as they can show dosage and may decline in strength in vivo, making them a common cause of delayed transfusion reactions.' },
                { clinicalDetails: '26 y/o female, antenatal booking.', screen: { I: '0', II: '2+', III: '0' }, auto: '0', iat: ['0', '2+', '0', '2+', '0', '0', '2+', '0', '0', '0', '0'], enzyme: ['0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'], solution: ['Anti-N'], notes: 'Reacts with N-positive cells (2, 4, 7). Like Anti-M, Anti-N is an enzyme-labile antibody, a key feature for identification. It is generally not considered clinically significant.' },
                { clinicalDetails: '69 y/o male, oncology patient.', screen: { I: '3+', II: '3+', III: '3+' }, auto: '0', iat: ['3+', '3+', '3+', '3+', '3+', '0', '0', '3+', '0', '0', '0'], enzyme: ['4+', '4+', '4+', '4+', '4+', '0', '0', '4+', '0', '0', '0'], solution: ['Anti-c', 'Anti-D'], notes: 'This combination reacts with all cells except 6 and 9, which are the only cells negative for both D and c. Both are Rh antibodies and are enhanced by enzyme treatment.' },
                { clinicalDetails: '30 y/o female, 32 weeks pregnant.', screen: { I: '3+', II: '3+', III: '3+' }, auto: '0', iat: ['3+', '3+', '3+', '2+', '0', '2+', '2+', '3+', '2+', '3+', '0'], enzyme: ['0', '3+', '3+', '3+', '0', '3+', '3+', '3+', '3+', '0', '0'], solution: ['Anti-M', 'Anti-Jkᵇ'], notes: 'A tricky combination. The enzyme panel destroys the M antigen, revealing an underlying Anti-Jkᵇ pattern. The remaining reactions in the IAT can then be attributed to Anti-M.' },
                { clinicalDetails: '81 y/o female, pre-op for hip fracture.', screen: { I: '2+', II: '2+', III: '0' }, auto: '0', iat: ['2+', '2+', '0', '2+', '2+', '2+', '2+', '2+', '2+', '2+', '2+'], enzyme: ['3+', '3+', '0', '3+', '3+', '3+', '3+', '3+', '3+', '3+', '3+'], solution: ['Anti-e'], notes: 'Reacts with all e-positive cells. Cell 3 is the only e-negative cell on this panel. The reactions are enhanced by enzyme treatment.' },
                { clinicalDetails: '58 y/o male, liver transplant list.', screen: { I: '3+', II: '3+', III: '3+' }, auto: '0', iat: ['3+', '3+', '3+', '3+', '3+', '3+', '3+', '3+', '3+', '0', '3+'], enzyme: ['4+', '4+', '4+', '4+', '4+', '4+', '4+', '4+', '4+', '0', '4+'], solution: ['Anti-C', 'Anti-e'], notes: 'This combination reacts with every cell on the panel except for cell 10. This is because cell 10 is the only one that is C-negative AND e-negative. Both are Rh antibodies and enhanced by enzyme.' },
                { clinicalDetails: '42 y/o female, unexpected antibody found during routine screen.', screen: { I: '3+', II: '3+', III: '3+' }, auto: '0', iat: ['3+', '3+', '3+', '0', '0', '2+', '0', '3+', '0', '0', '0'], enzyme: ['4+', '4+', '4+', '0', '0', '2+', '0', '4+', '0', '0', '0'], solution: ['Anti-D', 'Anti-K'], notes: 'The pattern fits Anti-D, but there is also a reaction with K-positive cell 6. Cell 2 is also K-positive but is already covered by Anti-D. This indicates a second antibody, Anti-K.' },
                { clinicalDetails: '21 y/o male, student, no medical history.', screen: { I: '0', II: '2+', III: '0' }, auto: '0', iat: ['0', '2+', '0', '0', '0', '0', '0', '0', '0', '0', '0'], enzyme: ['0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'], solution: ['Anti-Leᵃ'], notes: 'Reacts only with the Le(a)-positive cell (2). Lewis antibodies are often naturally occurring IgM and are not generally considered clinically significant. The antigens are destroyed by enzyme treatment.' },
                { clinicalDetails: '35 y/o female, antenatal, showing variable reaction strengths.', screen: 'N/A', auto: '0', iat: ['3+', '0', '0', '0', '1+', '1+', '0', '0', '1+', '1+', '0'], enzyme: ['0', '0', '0', '0', '0', '0', '0', '0', '0', '0', '0'], solution: ['Anti-Fyᵃ'], notes: 'This Anti-Fyᵃ is showing dosage. The reaction is stronger with the homozygous cell (Fy(a+b-)), cell 1 (3+), than with the heterozygous cells (Fy(a+b+)), cells 5, 6, 9, 10 (1+).' }
            ];
            
            // --- ELEMENTS & STATE ---
            let currentCaseIndex = 0;
            const elements = {
                table: document.getElementById('panel-table'),
                answerCheckboxes: document.getElementById('answer-checkboxes'),
                cwCheckbox: document.getElementById('cw-checkbox'),
                submitButton: document.getElementById('submit-answer'),
                nextCaseButton: document.getElementById('next-case'),
                feedbackEl: document.getElementById('feedback'),
                scoreEl: document.getElementById('score'),
                caseNumberEl: document.getElementById('case-number'),
                clinicalDetailsEl: document.getElementById('clinical-details'),
                notesContainer: document.getElementById('notes-container'),
                caseNotesEl: document.getElementById('case-notes'),
                tutorialButton: document.getElementById('tutorial-button'),
                closeTutorialButton: document.getElementById('close-tutorial'),
                tutorialModal: document.getElementById('tutorial-modal'),
                screenButton: document.getElementById('screen-button'),
                closeScreenButton: document.getElementById('close-screen'),
                screenModal: document.getElementById('screen-modal'),
                screenAntigram: document.getElementById('screen-antigram'),
                enzymeButton: document.getElementById('enzyme-button'),
                caseSelect: document.getElementById('case-select'),
                randomCaseButton: document.getElementById('random-case-button'),
            };
            
            let state = { score: 0 };

            // --- FUNCTIONS ---
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            function populateCaseSelector() {
                elements.caseSelect.innerHTML = '';
                gameCases.forEach((caseData, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `Case ${index + 1}`;
                    elements.caseSelect.appendChild(option);
                });
            }

            function renderPanelStructure() {
                elements.table.innerHTML = '';
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');
                
                const topHeaderRow = document.createElement('tr');
                topHeaderRow.innerHTML = '<th>Cell</th>';
                for (const system in panelAntigens) {
                    topHeaderRow.innerHTML += `<th colspan="${panelAntigens[system].length}">${system}</th>`;
                }
                topHeaderRow.innerHTML += '<th colspan="2">Reactions</th>';
                thead.appendChild(topHeaderRow);

                const bottomHeaderRow = document.createElement('tr');
                bottomHeaderRow.innerHTML = '<th>#</th>';
                panelAntigensList.forEach(ag => {
                    bottomHeaderRow.innerHTML += `<th class="antigen-header" data-antigen-index="${panelAntigensList.indexOf(ag)}">${ag.replace('a','ᵃ').replace('b','ᵇ').replace('w','ʷ')}</th>`;
                });
                bottomHeaderRow.innerHTML += '<th>IAT</th><th id="enzyme-header" class="hidden">Enzyme</th>';
                thead.appendChild(bottomHeaderRow);

                elements.table.appendChild(thead);
                elements.table.appendChild(tbody);
            }

            function loadCase(caseIndex) {
                currentCaseIndex = caseIndex;
                const caseData = gameCases[caseIndex];
                const tbody = elements.table.querySelector('tbody');
                tbody.innerHTML = '';

                panelCells.forEach((cell, index) => {
                    const row = document.createElement('tr');
                    let rowHtml = `<td class="font-bold">${index + 1}</td>`;
                    cell.profile.forEach((antigenResult, antigenIndex) => {
                        rowHtml += `<td data-col-index="${antigenIndex}">${antigenResult}</td>`;
                    });
                    rowHtml += `<td class="reaction-cell">${caseData.iat[index] || '0'}</td>`;
                    rowHtml += `<td class="reaction-cell hidden" data-enzyme-result="true">${caseData.enzyme[index] || '0'}</td>`;
                    row.innerHTML = rowHtml;
                    tbody.appendChild(row);
                });
                
                const autoRow = document.createElement('tr');
                autoRow.innerHTML = `<td class="font-bold">Auto</td><td colspan="${panelAntigensList.length}"></td><td class="reaction-cell">${caseData.auto}</td><td class="reaction-cell hidden" data-enzyme-result="true">${caseData.auto}</td>`;
                tbody.appendChild(autoRow);

                elements.caseNumberEl.textContent = `Case ${caseIndex + 1}`;
                elements.clinicalDetailsEl.textContent = caseData.clinicalDetails;
                elements.caseSelect.value = caseIndex;

                if (caseData.screen) {
                    document.getElementById('screen-I').textContent = caseData.screen.I;
                    document.getElementById('screen-II').textContent = caseData.screen.II;
                    document.getElementById('screen-III').textContent = caseData.screen.III;
                }

                populateScreenAntigram();

                elements.feedbackEl.textContent = 'A new case is ready for investigation.';
                elements.feedbackEl.className = 'mt-1 h-6 text-lg font-semibold text-gray-500';
                elements.submitButton.classList.remove('hidden');
                elements.nextCaseButton.classList.add('hidden');
                elements.notesContainer.classList.add('hidden');
                
                document.querySelectorAll('.answer-checkbox, #cw-checkbox').forEach(cb => {
                    cb.checked = false;
                    cb.disabled = false;
                });
                
                elements.enzymeButton.disabled = !caseData.enzyme;
                
                document.querySelectorAll('.antigen-header, td[data-col-index]').forEach(el => el.classList.remove('line-through'));
                document.getElementById('enzyme-header').classList.add('hidden');
                document.querySelectorAll('[data-enzyme-result]').forEach(el => el.classList.add('hidden'));
            }
            
            function populateScreenAntigram() {
                elements.screenAntigram.innerHTML = '';
                panelAntigensList.forEach((antigen, index) => {
                    const row = document.createElement('tr');
                    let rowHTML = `<td class="p-2 border font-bold text-left">${antigen.replace('a','ᵃ').replace('b','ᵇ')}</td>`;
                    rowHTML += `<td class="p-2 border">${panelCells[0].profile[index]}</td>`;
                    rowHTML += `<td class="p-2 border">${panelCells[1].profile[index]}</td>`;
                    rowHTML += `<td class="p-2 border">${panelCells[2].profile[index]}</td>`;
                    row.innerHTML = rowHTML;
                    elements.screenAntigram.appendChild(row);
                });
            }

            function populateAnswerOptions() {
            const allAntibodies = ['Anti-D', 'Anti-C', 'Anti-E', 'Anti-c', 'Anti-e', 'Anti-Cʷ', 'Anti-K', 'Anti-k', 'Anti-Kpa', 'Anti-Kpb', 'Anti-Fyᵃ', 'Anti-Fyᵇ', 'Anti-Jkᵃ', 'Anti-Jkᵇ', 'Anti-Lea', 'Anti-Leb', 'Anti-P1', 'Anti-S', 'Anti-s', 'Anti-M', 'Anti-N', 'Anti-Lua', 'Anti-Lub' 'Autoantibody'];                elements.answerCheckboxes.innerHTML = '';
                allAntibodies.forEach(ab => {
                    const label = document.createElement('label');
                    label.className = "flex items-center space-x-2";
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = ab;
                    checkbox.className = "answer-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500";
                    label.appendChild(checkbox);
                    const span = document.createElement('span');
                    span.innerHTML = ab.replace('a','ᵃ').replace('b','ᵇ').replace('w','ʷ');
                    label.appendChild(span);
                    elements.answerCheckboxes.appendChild(label);
                });
            }

            function checkAnswer() {
                const selectedAnswers = Array.from(document.querySelectorAll('.answer-checkbox:checked')).map(cb => cb.value);
                const correctAnswers = gameCases[currentCaseIndex].solution;
                
                selectedAnswers.sort();
                correctAnswers.sort();

                const isCorrect = JSON.stringify(selectedAnswers) === JSON.stringify(correctAnswers);

                if (isCorrect) {
                    elements.feedbackEl.textContent = 'Correct! Excellent work.';
                    elements.feedbackEl.className = 'mt-1 h-6 text-lg font-semibold text-green-600';
                    state.score += 10;
                    elements.scoreEl.textContent = state.score;
                } else {
                    elements.feedbackEl.textContent = `Not quite. The correct answer is ${correctAnswers.join(' and ')}.`;
                    elements.feedbackEl.className = 'mt-1 h-6 text-lg font-semibold text-red-600';
                }
                
                elements.caseNotesEl.textContent = gameCases[currentCaseIndex].notes;
                elements.notesContainer.classList.remove('hidden');
                elements.submitButton.classList.add('hidden');
                elements.nextCaseButton.classList.remove('hidden');
                document.querySelectorAll('.answer-checkbox, #cw-checkbox').forEach(cb => cb.disabled = true);
            }
            
            function toggleExclusion(columnIndex) {
                const th = document.querySelector(`.antigen-header[data-antigen-index="${columnIndex}"]`);
                const tds = document.querySelectorAll(`td[data-col-index="${columnIndex}"]`);
                th.classList.toggle('line-through');
                tds.forEach(td => td.classList.toggle('line-through'));
            }

            // --- EVENT LISTENERS ---
            elements.table.addEventListener('click', (e) => {
                if (e.target.closest('.antigen-header')) {
                    toggleExclusion(e.target.closest('.antigen-header').dataset.antigenIndex);
                }
            });
            
            elements.submitButton.addEventListener('click', checkAnswer);
            
            elements.nextCaseButton.addEventListener('click', () => {
                const nextIndex = (currentCaseIndex + 1) % gameCases.length;
                loadCase(nextIndex);
            });
            
            elements.enzymeButton.addEventListener('click', () => {
                if(!elements.enzymeButton.disabled) {
                    document.getElementById('enzyme-header').classList.remove('hidden');
                    document.querySelectorAll('[data-enzyme-result]').forEach(el => el.classList.remove('hidden'));
                    elements.enzymeButton.disabled = true;
                }
            });

            elements.tutorialButton.addEventListener('click', () => elements.tutorialModal.classList.add('active'));
            elements.closeTutorialButton.addEventListener('click', () => elements.tutorialModal.classList.remove('active'));
            elements.screenButton.addEventListener('click', () => elements.screenModal.classList.add('active'));
            elements.closeScreenButton.addEventListener('click', () => elements.screenModal.classList.remove('active'));
            elements.caseSelect.addEventListener('change', (e) => {
                loadCase(parseInt(e.target.value, 10));
            });
            elements.randomCaseButton.addEventListener('click', () => {
                const randomIndex = Math.floor(Math.random() * gameCases.length);
                loadCase(randomIndex);
            });

            // --- INITIALIZATION ---
            shuffleArray(gameCases);
            populateCaseSelector();
            renderPanelStructure();
            populateAnswerOptions();
            loadCase(0);
        });
    </script>
</body>
</html>
