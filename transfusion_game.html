<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antibody Identification Challenge - Clinical Pathology</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .panel-table { border-collapse: collapse; white-space: nowrap; }
        .panel-table th, .panel-table td { border: 1px solid #d1d5db; padding: 0.25rem 0.5rem; text-align: center; position: relative; }
        .panel-table th { background-color: #f3f4f6; }
        .antigen-header { cursor: pointer; user-select: none; }
        .line-through::after {
            content: '';
            position: absolute;
            top: -1px; /* Adjust to align with borders */
            left: 50%;
            width: 2px;
            height: calc(100% + 2px); /* Adjust to align with borders */
            background-color: rgba(239, 68, 68, 0.6);
            transform: translateX(-50%);
            pointer-events: none;
        }
        .reaction-cell { font-weight: bold; }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

    <div id="header-placeholder"></div>

    <main class="container mx-auto px-4 py-8 flex-grow">

        <section class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-2">Antibody Identification Challenge</h1>
            <p class="text-lg text-gray-600">Use your skills and tools to solve the antibody puzzle.</p>
        </section>

        <div class="bg-white p-6 rounded-lg shadow-md max-w-full mx-auto">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <div>
                    <h2 class="text-2xl font-bold">Case File: <span id="case-name"></span></h2>
                    <p id="feedback" class="mt-1 h-6 text-lg font-semibold text-gray-500">A new case is ready for investigation.</p>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <button id="tutorial-button" class="bg-blue-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-blue-600 transition-colors text-sm md:text-base"><i class="fas fa-question-circle mr-1"></i>How to Investigate</button>
                    <div class="text-lg font-bold">Score: <span id="score">0</span></div>
                </div>
            </div>

            <div class="flex flex-wrap gap-4 my-4">
                <button id="screen-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg"><i class="fas fa-vials mr-2"></i>View Screen Cells</button>
                <button id="enzyme-button" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-4 rounded-lg"><i class="fas fa-magic mr-2"></i>Run Enzyme Panel</button>
            </div>
            
            <div class="overflow-x-auto">
                <table id="panel-table" class="panel-table w-full text-sm"></table>
            </div>

            <div class="mt-6 flex flex-col md:flex-row items-center justify-center gap-4">
                <label for="answer-select" class="font-bold text-lg">Final Identification:</label>
                <select id="answer-select" class="p-2 border border-gray-300 rounded-lg"></select>
                <button id="submit-answer" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition-colors">Submit Report</button>
                 <button id="next-case" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors hidden">Next Case</button>
            </div>
        </div>
        
        <section class="text-center mt-12">
            <a href="games.html" class="bg-gray-800 text-white font-bold py-3 px-8 rounded-full hover:bg-gray-700 transition duration-300">
                <i class="fas fa-arrow-left mr-2"></i>Back to Games
            </a>
        </section>
    </main>
    
    <div id="tutorial-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">How to Investigate an Antibody Panel</h2>
            <div class="text-left space-y-3">
                <p><strong>The Goal:</strong> To find an antibody that explains all positive reactions, while being excluded by all negative reactions.</p>
                <h3 class="font-bold text-lg mt-2">1. The Exclusion Step (Ruling Out)</h3>
                <p>Look at rows where the patient's IAT result is <strong class="text-red-600">negative (0)</strong>. Find an antigen on that row for which the cell is <strong>homozygous</strong> (e.g., K+k- is homozygous for K; Fy(a+b-) is homozygous for Fy<sup>a</sup>). If the reaction is negative, you can confidently exclude that antibody. Click the antigen header to draw a line through it.</p>
                
                <h3 class="font-bold text-lg mt-2">2. The Inclusion Step (Pattern Matching)</h3>
                <p>After excluding as many antibodies as possible, look at the remaining possibilities. The pattern of <strong class="text-green-600">positive (+)</strong> reactions in the patient column should match the antigen profile of one of the remaining antibodies. To formally identify an antibody, it should react with at least two cells that have the antigen and be non-reactive with at least two cells that lack it (the 2+2 rule).</p>

                <h3 class="font-bold text-lg mt-2">3. Using the Enzyme Panel</h3>
                <p>If the IAT panel is complex, running an enzyme panel can help. Enzymes destroy some antigens (like Fy<sup>a</sup>, Fy<sup>b</sup>, M, N, S) and enhance others (like Rh and Kidd antigens). If a reaction disappears in the enzyme panel, it points towards an antibody in the Duffy or MNS system. If it gets stronger, it may be an Rh or Kidd antibody.</p>
                
                 <h3 class="font-bold text-lg mt-2">4. Final Checks</h3>
                 <p>Always check the <strong>Auto-Control</strong>. A positive result can indicate an autoantibody, which may complicate the investigation. Also, consider <strong>dosage</strong> - some antibodies (like Rh, Kidd, Duffy) may show weaker (w+) reactions with heterozygous cells.</p>
            </div>
            <button id="close-tutorial" class="mt-6 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors float-right">Close</button>
        </div>
    </div>
    <div id="screen-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
         <div class="bg-white rounded-lg shadow-xl p-6 w-auto">
            <h2 class="text-2xl font-bold mb-4">Initial Antibody Screen Result</h2>
            <table class="w-full text-center">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-2 border">Screen Cell I</th>
                        <th class="p-2 border">Screen Cell II</th>
                        <th class="p-2 border">Screen Cell III</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="screen-I" class="p-2 border text-2xl font-bold"></td>
                        <td id="screen-II" class="p-2 border text-2xl font-bold"></td>
                        <td id="screen-III" class="p-2 border text-2xl font-bold"></td>
                    </tr>
                </tbody>
            </table>
            <button id="close-screen" class="mt-6 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors float-right">Close</button>
        </div>
    </div>

    <div id="footer-placeholder"></div>
    <script src="js/component-loader.js"></script>
    <script src="transfusion_game_logic.js"></script>
</body>
</html>
