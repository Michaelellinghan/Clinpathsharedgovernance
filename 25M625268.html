<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morphology Case 25M625268</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nhs-blue { background-color: #005EB8; }
        .nhs-dark-blue { background-color: #003087; }
        .nhs-text-blue { color: #005EB8; }
        .nhs-text-dark-blue { color: #003087; }
        .results-table { font-size: 0.9rem; }
        .results-table td { padding: 0.25rem 0.5rem; border-bottom: 1px solid #e5e7eb; }
        .results-table tr:last-child td { border-bottom: none; }
        .feature-checkbox:disabled { opacity: 0.7; }
        .feature-label:has(.feature-checkbox:disabled) { cursor: not-allowed; color: #6b7280; }
        .highlight-correct { background-color: #dcfce7; color: #166534; }
        .highlight-abnormal { background-color: #fee2e2; }
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal-content { margin: auto; display: block; max-width: 85%; max-height: 85%; transition: transform 0.2s ease; cursor: zoom-in; }
        .modal-content.zoomed { transform: scale(2); cursor: zoom-out; }
        .modal-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
        .modal-nav { cursor: pointer; position: absolute; top: 50%; width: auto; padding: 16px; margin-top: -22px; color: white; font-weight: bold; font-size: 20px; transition: 0.3s ease; user-select: none; background-color: rgba(0,0,0,0.3); }
        .modal-nav:hover { background-color: rgba(0,0,0,0.8); }
        .modal-prev { left: 0; border-radius: 0 3px 3px 0; }
        .modal-next { right: 0; border-radius: 3px 0 0 3px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

        <div id="header-placeholder"></div>

    <main class="py-16">
        <div class="container mx-auto px-6 max-w-7xl">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold nhs-text-dark-blue">Morphology Case Library</h2>
                <p class="text-lg text-gray-600">Case Study: 25M625268</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-semibold nhs-text-dark-blue border-b pb-2 mb-4">Case Information</h3>
                        <div id="initial-info">
                             <h4 class="font-bold mt-4">Patient Demographics</h4>
                             <p>29-year-old male</p>
                             <h4 class="font-bold mt-4">Clinical Details</h4>
                             <p>Pyrexia ?infection</p>
                             <h4 class="font-bold mt-4">Full Blood Count</h4>
                            <table class="w-full results-table mt-2">
                                <tr><td>HGB</td><td class="font-mono text-right">139 g/L</td></tr>
                                <tr><td>WBC</td><td class="font-mono text-right">8.72 x10⁹/L</td></tr>
                                <tr><td>PLT</td><td class="font-mono text-right">161 x10⁹/L</td></tr>
                                <tr><td>MPV</td><td class="font-mono text-right">10.9 fL</td></tr>
                                <tr><td>RBC</td><td class="font-mono text-right">4.44 x10¹²/L</td></tr>
                                <tr id="hct-row"><td>HCT</td><td class="font-mono text-right">0.387 L/L</td></tr>
                                <tr><td>MCV</td><td class="font-mono text-right">87.2 fL</td></tr>
                                <tr><td>MCH</td><td class="font-mono text-right">31.3 pg</td></tr>
                                <tr id="mchc-row"><td>MCHC</td><td class="font-mono text-right">359 g/L</td></tr>
                                <tr><td>RDW-CV</td><td class="font-mono text-right">12.2 %</td></tr>
                            </table>
                             <h4 class="font-bold mt-4">Automated Differential</h4>
                             <table class="w-full results-table mt-2">
                                <tr><td>Neutrophils</td><td class="font-mono text-right">7.23 x10⁹/L (82.9%)</td></tr>
                                <tr id="lymph-row"><td>Lymphocytes</td><td class="font-mono text-right">0.61 x10⁹/L (7.0%)</td></tr>
                                <tr><td>Monocytes</td><td class="font-mono text-right">0.81 x10⁹/L (9.3%)</td></tr>
                                <tr><td>Eosinophils</td><td class="font-mono text-right">0.03 x10⁹/L (0.3%)</td></tr>
                                <tr><td>Basophils</td><td class="font-mono text-right">0.04 x10⁹/L (0.5%)</td></tr>
                            </table>
                        </div>
                        <div id="full-case-details" class="hidden mt-4 pt-4 border-t">
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-semibold nhs-text-dark-blue border-b pb-2 mb-4">Blood Film Examination</h3>
                        <div class="mb-6">
                            <h4 class="font-semibold text-lg">Red Cell Picture</h4>
                            <div id="red-cell-container" class="cursor-pointer">
                                <img id="red-cell-img" src="morphology/25M625268/25M625268 red cells.PNG" alt="Overall red cell picture for case" class="rounded-md w-full h-auto mt-2 shadow">
                            </div>
                        </div>
                        <div>
                             <h4 class="font-semibold text-lg">White Cell Gallery</h4>
                             <p class="text-sm text-gray-600 mb-2">Click a thumbnail to view the full-size image.</p>
                             <div id="wbc-gallery" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 max-h-96 overflow-y-auto pr-2">
                                 </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-2xl font-semibold nhs-text-dark-blue border-b pb-2 mb-4">Morphology Checklist</h3>
                    <p class="text-gray-600 mb-4">Select up to three key morphological features you have identified.</p>
                    
                    <div id="feature-checklist" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        </div>

                    <button id="reveal-btn" onclick="checkMorphology()" class="w-full mt-6 bg-black text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 transition duration-300">See Results</button>
                    
                    <div id="results" class="mt-4"></div>

                    <div id="analysis-section" class="hidden mt-6 border-t pt-6">
                        <h3 class="text-2xl font-semibold nhs-text-dark-blue mb-4">Analysis & Peer Consensus</h3>
                        
                        <div class="mb-6">
                            <h4 class="text-lg font-bold">Your Selected Features:</h4>
                            <ul id="user-choices" class="list-disc list-inside mt-2"></ul>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="text-lg font-bold">Expert Commentary</h4>
                            <div class="mt-2 p-4 bg-gray-100 rounded-md text-gray-700">
                                <p id="expert-comment-text" class="whitespace-pre-wrap"></p>
                            </div>
                        </div>

                        <div>
                            <h4 class="text-lg font-bold">Top Features</h4>
                            <table class="w-full text-left mt-2 text-sm">
                                <thead>
                                    <tr class="bg-gray-50"><th class="p-2">Feature</th><th
                                </thead>
                                <tbody id="top-features-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                                        <section class="text-center mt-12">
                <a href="morphology_cases.html" class="bg-gray-800 text-white font-bold py-3 px-8 rounded-full hover:bg-gray-700 transition duration-300">
                    <i class="fas fa-arrow-left mr-2"></i>Back to More Cases
                </a>
            </section>
    </main>

    <div id="image-modal" class="modal">
        <span class="modal-close" id="modal-close-btn">&times;</span>
        <a class="modal-prev modal-nav" id="modal-prev-btn">&#10094;</a>
        <a class="modal-next modal-nav" id="modal-next-btn">&#10095;</a>
        <img class="modal-content" id="modal-img">
    </div>

    <div id="footer-placeholder"></div>

      <script src="js/component-loader.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
        });
   </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Initialise Feather Icons ---
            feather.replace();

            // --- Page Data for Case ---
            const imageFilenames = ["BNE_825112.jpg", "BNE_825114.jpg", "BNE_825115.jpg", "BNE_825143.jpg", "BNE_825144.jpg", "BNE_825152.jpg", "BNE_825157.jpg", "BNE_825166.jpg", "BNE_825188.jpg", "BNE_825198.jpg", "BNE_825200.jpg", "BNE_825202.jpg", "BNE_825207.jpg", "BNE_825212.jpg", "BNE_825220.jpg", "BNE_825226.jpg", "BNE_825240.jpg", "BNE_825248.jpg", "BNE_825249.jpg", "BNE_825258.jpg", "BNE_825261.jpg", "BNE_825265.jpg", "BNE_825276.jpg", "BNE_825286.jpg", "BNE_825288.jpg", "BNE_825302.jpg", "BNE_825303.jpg", "BNE_825328.jpg", "BNE_825331.jpg", "BNE_825340.jpg", "BNE_825361.jpg", "BNE_825366.jpg", "LY_825119.jpg", "LY_825145.jpg", "LY_825165.jpg", "LY_825167.jpg", "LY_825218.jpg", "LY_825227.jpg", "LY_825264.jpg", "LY_825275.jpg", "LY_825279.jpg", "LY_825281.jpg", "LY_825283.jpg", "LY_825326.jpg", "LY_825341.jpg", "LY_825346.jpg", "LY_825362.jpg", "LY_825378.jpg", "MMY_825184.jpg", "MMY_825242.jpg", "MMY_825307.jpg", "MMY_825351.jpg", "MO_825175.jpg", "MO_825229.jpg", "PC_825182.jpg", "PC_825193.jpg", "SNE_825098.jpg", "SNE_825099.jpg", "SNE_825100.jpg", "SNE_825107.jpg", "SNE_825108.jpg", "SNE_825110.jpg", "SNE_825113.jpg", "SNE_825117.jpg", "SNE_825118.jpg", "SNE_825120.jpg", "SNE_825124.jpg", "SNE_825128.jpg", "SNE_825129.jpg", "SNE_825131.jpg", "SNE_825134.jpg", "SNE_825136.jpg", "SNE_825137.jpg", "SNE_825139.jpg", "SNE_825147.jpg", "SNE_825148.jpg", "SNE_825151.jpg", "SNE_825155.jpg", "SNE_825160.jpg", "SNE_825161.jpg", "SNE_825164.jpg", "SNE_825173.jpg", "SNE_825174.jpg", "SNE_825183.jpg", "SNE_825185.jpg", "SNE_825194.jpg", "SNE_825196.jpg", "SNE_825197.jpg", "SNE_825199.jpg", "SNE_825201.jpg", "SNE_825203.jpg", "SNE_825205.jpg", "SNE_825208.jpg", "SNE_825213.jpg", "SNE_825214.jpg", "SNE_825215.jpg", "SNE_825216.jpg", "SNE_825217.jpg", "SNE_825230.jpg", "SNE_825231.jpg", "SNE_825232.jpg", "SNE_825233.jpg", "SNE_825234.jpg", "SNE_825236.jpg", "SNE_825237.jpg", "SNE_825239.jpg", "SNE_825241.jpg", "SNE_825243.jpg", "SNE_825244.jpg", "SNE_825245.jpg", "SNE_825246.jpg", "SNE_825247.jpg", "SNE_825250.jpg", "SNE_825252.jpg", "SNE_825253.jpg", "SNE_825254.jpg", "SNE_825255.jpg", "SNE_825256.jpg", "SNE_825259.jpg", "SNE_825260.jpg", "SNE_825263.jpg", "SNE_825266.jpg", "SNE_825267.jpg", "SNE_825268.jpg", "SNE_825269.jpg", "SNE_825270.jpg", "SNE_825271.jpg", "SNE_825272.jpg", "SNE_825273.jpg", "SNE_825277.jpg", "SNE_825278.jpg", "SNE_825285.jpg", "SNE_825287.jpg", "SNE_825289.jpg", "SNE_825293.jpg", "SNE_825299.jpg", "SNE_825300.jpg", "SNE_825301.jpg", "SNE_825304.jpg", "SNE_825306.jpg", "SNE_825310.jpg", "SNE_825311.jpg", "SNE_825314.jpg", "SNE_825315.jpg", "SNE_825316.jpg", "SNE_825317.jpg", "SNE_825318.jpg", "SNE_825319.jpg", "SNE_825321.jpg", "SNE_825322.jpg", "SNE_825323.jpg", "SNE_825324.jpg", "SNE_825325.jpg", "SNE_825327.jpg", "SNE_825330.jpg", "SNE_825332.jpg", "SNE_825333.jpg", "SNE_825334.jpg", "SNE_825335.jpg", "SNE_825338.jpg", "SNE_825339.jpg", "SNE_825344.jpg", "SNE_825345.jpg", "SNE_825347.jpg", "SNE_825349.jpg", "SNE_825350.jpg", "SNE_825356.jpg", "SNE_825358.jpg", "SNE_825359.jpg", "SNE_825360.jpg", "SNE_825364.jpg", "SNE_825365.jpg", "SNE_825369.jpg", "SNE_825370.jpg", "SNE_825371.jpg", "SNE_825372.jpg", "SNE_825373.jpg", "SNE_825374.jpg", "SNE_825380.jpg", "SNE_825381.jpg", "SNE_825382.jpg", "UI_825116.jpg", "UI_825126.jpg", "UI_825153.jpg", "UI_825156.jpg", "UI_825178.jpg", "UI_825179.jpg", "UI_825186.jpg", "UI_825189.jpg", "UI_825190.jpg", "UI_825211.jpg", "UI_825219.jpg", "UI_825238.jpg", "UI_825295.jpg", "UI_825297.jpg", "UI_825336.jpg", "UI_825348.jpg", "UI_825379.jpg", "UI_825383.jpg"];
            const expertComment = "The patient's clinical presentation of pyrexia and the blood film findings are highly suggestive of malaria. The presence of P. falciparum ring forms confirms the diagnosis. The parasitaemia of <1% is noted. The rapid test being positive for a non-falciparum species is discordant with the film finding and highlights the importance of microscopy. The report from the London School of Hygiene and Tropical Medicine further supports the diagnosis, describing trophozoites, delicate ring forms, and multiple parasites in some red blood cells. These are all classic features of Plasmodium falciparum infection. The lymphopenia is also a common finding in acute malaria.";
            
            const topPeerFeatures = [
                {"feature":"Trophozoites"},
                {"feature":"Ring forms"},
                {"feature":"Multiple parasites per cell"},
            ];

            const morphologyFeatures = {"Red Cell Features":["Anaemia","Microcytes","Hypochromic Cells","Polychromatic Cells","Mixed Cell Population (Dimorphic)","Poikilocytes","Target Cells","Echinocytes/Crenated Cells","Fragments/Schistocytes","Sickle Cells","Spherocytes","Rouleaux","Basophilic Stippling","Nucleated RBCs","Acanthocytes","Tear Drop Poikilocytes","Keratocytes/Bite Cells","Boat-shaped Cells","Howell-Jolly Bodies", "Elliptocytes"],"White Cell Features":["Leukocytosis","Eosinophilia","Band Form Neutrophils","Toxic Granulation","Hypogranular/Agranular Cytoplasm (Neutrophils)","Blast Cells","Promyelocytes","Prolymphocytes","Myelocytes","Smear/Smudge Cells","Atypical/Suspect Reactive Lymphocytes","Reactive/Plasmacytoid Lymphocytes","Cleft Nuclei","Plasma Cells","Auer Rods","Basophilia","Neutropenia","Lymphocytosis","Lymphopenia","Abnormal/Suspect Neoplastic Lymphocytes","Large Granular Lymphocytes","Left Shift","Pseudo-Pelger Cells","Promonocytes"],"Platelet Features":["Thrombocytosis","Thrombocytopenia","Large/Giant Platelets","Platelet Anisocytosis","Platelet Clumps"], "Parasite Features": ["Trophozoites", "Ring forms", "Multiple parasites per cell"]};
            
            // --- UI Element References ---
            const checklistContainer = document.getElementById('feature-checklist');
            const galleryContainer = document.getElementById('wbc-gallery');
            const revealBtn = document.getElementById('reveal-btn');
            const analysisSection = document.getElementById('analysis-section');
            const fullDetailsSection = document.getElementById('full-case-details');
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-img');
            const closeModalBtn = document.getElementById('modal-close-btn');
            const prevBtn = document.getElementById('modal-prev-btn');
            const nextBtn = document.getElementById('modal-next-btn');
            const redCellContainer = document.getElementById('red-cell-container');

            let currentImageIndex = 0;
            const imagePath = 'morphology/25M625268/';
            const allGalleryImages = [document.getElementById('red-cell-img').src, ...imageFilenames.map(name => imagePath + name)];

            // --- UI Population ---
            for (const category in morphologyFeatures) {
                let categoryHtml = `<h4 class="font-bold mt-4 text-gray-700">${category}</h4>`;
                morphologyFeatures[category].forEach(feature => {
                    categoryHtml += `<label class="feature-label flex items-center space-x-3 cursor-pointer"><input type="checkbox" value="${feature}" class="feature-checkbox h-5 w-5 rounded border-gray-300 text-nhs-blue focus:ring-nhs-blue" data-feature="${feature}"><span>${feature}</span></label>`;
                });
                checklistContainer.innerHTML += categoryHtml;
            }


            imageFilenames.forEach(filename => {
                const img = document.createElement('img');
                img.src = imagePath + filename;
                img.alt = `Morphology image: ${filename}`;
                img.className = 'w-full h-auto rounded cursor-pointer hover:opacity-75 transition-opacity';
                galleryContainer.appendChild(img);
            });
            
            // --- Event Logic ---
            const openModal = (startIndex) => {
                currentImageIndex = startIndex;
                modal.style.display = "flex";
                modalImg.src = allGalleryImages[currentImageIndex];
                modalImg.classList.remove('zoomed');
            };

            const showImage = (newIndex) => {
                currentImageIndex = (newIndex + allGalleryImages.length) % allGalleryImages.length;
                modalImg.src = allGalleryImages[currentImageIndex];
                modalImg.classList.remove('zoomed');
            };
            
            redCellContainer.addEventListener('click', () => openModal(0));
            
            Array.from(galleryContainer.children).forEach((thumb, index) => {
                thumb.addEventListener('click', () => openModal(index + 1)); 
            });

            prevBtn.addEventListener('click', (e) => { e.stopPropagation(); showImage(currentImageIndex - 1); });
            nextBtn.addEventListener('click', (e) => { e.stopPropagation(); showImage(currentImageIndex + 1); });
            closeModalBtn.onclick = () => { modal.style.display = "none"; };
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = "none"; });
            modalImg.addEventListener('click', (e) => { e.stopPropagation(); e.target.classList.toggle('zoomed'); });

            checklistContainer.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    if (document.querySelectorAll('.feature-checkbox:checked').length > 3) {
                        e.target.checked = false;
                        alert('You can select a maximum of three features.');
                    }
                }
            });
        });

        function checkMorphology() {
            const correctFeatures = ["Trophozoites", "Ring forms", "Multiple parasites per cell"];
            const checkboxes = document.querySelectorAll('#feature-checklist input[type="checkbox"]:checked');
            const selectedFeatures = Array.from(checkboxes).map(cb => cb.value);
            const resultContainer = document.getElementById('result