<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anticoagulant Challenge - SGC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nhs-blue { background-color: #005EB8; }
        .nhs-dark-blue { background-color: #003087; }
        .nhs-light-grey { background-color: #F0F4F5; }
        .nhs-text-blue { color: #005EB8; }
        .nhs-text-dark-blue { color: #003087; }

        /* Custom styles for radio buttons disguised as buttons */
        .effect-label {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        
        .effect-radio:checked + .effect-label {
            background-color: #005EB8; /* nhs-blue */
            color: white;
            border-color: #003087; /* nhs-dark-blue */
            transform: scale(1.05);
        }
        
        .effect-radio:disabled + .effect-label {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Feedback styles */
        .correct-answer {
             box-shadow: 0 0 0 3px #10b981; /* Green-500 */
        }
        .incorrect-answer {
             box-shadow: 0 0 0 3px #ef4444; /* Red-500 */
        }
    </style>
</head>
<body class="bg-nhs-light-grey text-gray-800 flex flex-col min-h-screen">

    <div id="header-placeholder"></div>

    <main class="py-12 md:py-16 flex-grow">
        <div class="container mx-auto px-4 sm:px-6 max-w-2xl text-center">
            <a href="games.html" class="inline-flex items-center nhs-text-blue font-semibold mb-8 hover:underline">
                <i data-feather="arrow-left" class="w-4 h-4 mr-2"></i>Back to Games
            </a>
            <h1 class="text-3xl font-bold nhs-text-dark-blue mb-2">Anticoagulant Challenge</h1>
            <p class="text-gray-600 mb-8">What is the typical effect of this drug on these coagulation tests?</p>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-r-lg">
                    <h2 class="text-2xl font-bold" id="drug-name">Warfarin</h2>
                </div>

                <div id="questions-container" class="space-y-6">
                    <!-- Questions will be generated by JS -->
                </div>

                <div id="feedback-container" class="mt-6 text-left p-4 rounded-lg bg-gray-100 border border-gray-200 hidden">
                    <h3 class="font-bold text-lg mb-2 nhs-text-dark-blue">Explanation</h3>
                    <p id="explanation-text" class="text-gray-700"></p>
                </div>

                <div class="mt-6">
                    <button id="check-answers-btn" class="w-full bg-gray-800 text-white font-bold py-3 px-8 rounded-lg hover:bg-black transition duration-300 text-xl">Check Answers</button>
                    <!-- FIXED: Replaced custom classes with standard Tailwind classes for visibility -->
                    <button id="next-drug-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 text-xl hidden">Next Drug</button>
                </div>
            </div>
            
            <div class="mt-8 bg-white p-4 rounded-lg shadow-md">
                <p class="text-lg">Score: <span id="score" class="font-bold">0</span></p>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="js/component-loader.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const drugNameEl = document.getElementById('drug-name');
            const questionsContainerEl = document.getElementById('questions-container');
            const checkAnswersBtn = document.getElementById('check-answers-btn');
            const nextDrugBtn = document.getElementById('next-drug-btn');
            const feedbackContainerEl = document.getElementById('feedback-container');
            const explanationTextEl = document.getElementById('explanation-text');
            const scoreEl = document.getElementById('score');

            // --- Game Data ---
            const anticoagulants = [
                {
                    name: 'Warfarin',
                    effects: { aptt: 'High', pt: 'High', tt: 'Normal' },
                    explanation: 'Warfarin inhibits the synthesis of Vitamin K-dependent clotting factors (II, VII, IX, X). This significantly prolongs the PT (highly sensitive to Factor VII) and also prolongs the APTT. The Thrombin Time (TT) is unaffected.'
                },
                {
                    name: 'Unfractionated Heparin (UFH)',
                    effects: { aptt: 'High', pt: 'High', tt: 'High' },
                    explanation: 'UFH works by potentiating Antithrombin, which then inhibits multiple clotting factors, most importantly Thrombin (Factor IIa) and Factor Xa. This leads to a prolongation of all three major clotting tests.'
                },
                {
                    name: 'LMWH (e.g., Enoxaparin)',
                    effects: { aptt: 'Normal', pt: 'Normal', tt: 'Normal' },
                    explanation: 'Low Molecular Weight Heparin (LMWH) has a more specific action, primarily inhibiting Factor Xa with less effect on Thrombin. Standard clotting tests like PT and APTT are often insensitive to therapeutic levels of LMWH. An Anti-Xa assay is required for accurate monitoring.'
                },
                {
                    name: 'Rivaroxaban (A DOAC)',
                    effects: { aptt: 'High', pt: 'High', tt: 'Normal' },
                    explanation: 'Rivaroxaban is a direct inhibitor of Factor Xa. This typically prolongs the PT and can have a variable effect on the APTT depending on the reagent used. The Thrombin Time (TT) is normal as it does not affect Thrombin directly.'
                },
                {
                    name: 'Apixaban (A DOAC)',
                    effects: { aptt: 'High', pt: 'High', tt: 'Normal' },
                    explanation: 'Apixaban is another direct Factor Xa inhibitor. Similar to Rivaroxaban, its effect on the PT and APTT can be variable and reagent-dependent, making these tests unreliable for monitoring drug levels. The TT is normal.'
                },
                {
                    name: 'Dabigatran (A DOAC)',
                    effects: { aptt: 'High', pt: 'High', tt: 'High' },
                    explanation: 'Dabigatran is a direct inhibitor of Thrombin (Factor IIa). Because it targets the final common step of the cascade, it strongly prolongs the Thrombin Time (TT) and the APTT. It also has a lesser effect on the PT.'
                },
                {
                    name: 'Aspirin (Antiplatelet)',
                    effects: { aptt: 'Normal', pt: 'Normal', tt: 'Normal' },
                    explanation: 'Aspirin is an antiplatelet agent, not an anticoagulant. It inhibits platelet function but does not affect the soluble clotting factors measured by the APTT, PT, or TT. Therefore, these tests remain normal.'
                },
                {
                    name: 'Clopidogrel (Antiplatelet)',
                    effects: { aptt: 'Normal', pt: 'Normal', tt: 'Normal' },
                    explanation: 'Like Aspirin, Clopidogrel is an antiplatelet drug. It prevents platelets from aggregating but has no effect on the plasma-based clotting cascade, so routine coagulation tests are unaffected.'
                }
            ];

            // --- Game State ---
            let currentDrug = {};
            let score = 0;
            let usedDrugs = [];

            // --- Game Logic ---
            
            function buildQuestions() {
                questionsContainerEl.innerHTML = '';
                const tests = ['aptt', 'pt', 'tt'];
                tests.forEach(test => {
                    const testName = test.toUpperCase();
                    const questionHTML = `
                        <div class="text-left" id="q-container-${test}">
                            <p class="text-lg font-semibold text-gray-700 mb-2">${testName}</p>
                            <div class="flex justify-center space-x-2 sm:space-x-4">
                                <div class="flex-1">
                                    <input type="radio" name="${test}" id="${test}-high" value="High" class="effect-radio hidden">
                                    <label for="${test}-high" class="effect-label block w-full text-center p-3 border-2 border-gray-300 rounded-lg font-bold">High</label>
                                </div>
                                <div class="flex-1">
                                    <input type="radio" name="${test}" id="${test}-normal" value="Normal" class="effect-radio hidden">
                                    <label for="${test}-normal" class="effect-label block w-full text-center p-3 border-2 border-gray-300 rounded-lg font-bold">Normal</label>
                                </div>
                                <div class="flex-1">
                                    <input type="radio" name="${test}" id="${test}-low" value="Low" class="effect-radio hidden">
                                    <label for="${test}-low" class="effect-label block w-full text-center p-3 border-2 border-gray-300 rounded-lg font-bold">Low</label>
                                </div>
                            </div>
                        </div>
                    `;
                    questionsContainerEl.insertAdjacentHTML('beforeend', questionHTML);
                });
            }

            function startGame() {
                score = 0;
                usedDrugs = [];
                scoreEl.textContent = score;
                buildQuestions();
                nextRound();
            }

            function nextRound() {
                // Reset UI
                feedbackContainerEl.classList.add('hidden');
                checkAnswersBtn.classList.remove('hidden');
                nextDrugBtn.classList.add('hidden');
                
                // Clear previous selections and feedback styles
                document.querySelectorAll('.effect-radio').forEach(radio => {
                    radio.checked = false;
                    radio.disabled = false;
                });
                document.querySelectorAll('.effect-label').forEach(label => {
                    label.classList.remove('correct-answer', 'incorrect-answer');
                });

                // Select a new drug
                if (usedDrugs.length === anticoagulants.length) {
                    usedDrugs = []; // Reset if all drugs have been shown
                }
                let availableDrugs = anticoagulants.filter(drug => !usedDrugs.includes(drug.name));
                currentDrug = availableDrugs[Math.floor(Math.random() * availableDrugs.length)];
                usedDrugs.push(currentDrug.name);

                drugNameEl.textContent = currentDrug.name;
            }

            function checkAnswers() {
                let roundScore = 0;
                const tests = ['aptt', 'pt', 'tt'];
                
                tests.forEach(test => {
                    const selectedRadio = document.querySelector(`input[name="${test}"]:checked`);
                    const container = document.getElementById(`q-container-${test}`);
                    
                    if (selectedRadio) {
                        const userAnswer = selectedRadio.value;
                        const correctAnswer = currentDrug.effects[test];
                        
                        const userLabel = selectedRadio.nextElementSibling;

                        if (userAnswer === correctAnswer) {
                            roundScore++;
                            userLabel.classList.add('correct-answer');
                        } else {
                            userLabel.classList.add('incorrect-answer');
                            // Also highlight the correct answer
                            const correctRadio = document.getElementById(`${test}-${correctAnswer.toLowerCase()}`);
                            if(correctRadio) {
                                correctRadio.nextElementSibling.classList.add('correct-answer');
                            }
                        }
                    } else {
                        // If no answer was selected, highlight the correct one
                        const correctAnswer = currentDrug.effects[test];
                        const correctRadio = document.getElementById(`${test}-${correctAnswer.toLowerCase()}`);
                        if(correctRadio) {
                            correctRadio.nextElementSibling.classList.add('correct-answer');
                        }
                    }
                });

                // Update total score and display explanation
                score += roundScore;
                scoreEl.textContent = score;
                explanationTextEl.textContent = currentDrug.explanation;
                feedbackContainerEl.classList.remove('hidden');

                // Disable all inputs and switch buttons
                document.querySelectorAll('.effect-radio').forEach(radio => radio.disabled = true);
                checkAnswersBtn.classList.add('hidden');
                nextDrugBtn.classList.remove('hidden');
            }

            // --- Event Listeners ---
            checkAnswersBtn.addEventListener('click', checkAnswers);
            nextDrugBtn.addEventListener('click', nextRound);

            // --- Initialisation ---
            startGame();
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        });
    </script>
</body>
</html>
