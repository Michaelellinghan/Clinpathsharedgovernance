<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGC Master Content Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .sidebar { scrollbar-width: thin; scrollbar-color: #d1d5db #f9fafb; }
        .sidebar-link.active { background-color: #005EB8; color: white; }
        .sidebar-link.active:hover { background-color: #0052a3; }
        .modal-body { max-height: 70vh; }
        textarea { min-height: 120px; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-72 bg-white border-r flex flex-col">
            <div class="flex items-center justify-center h-20 border-b flex-shrink-0">
                <h1 class="text-xl font-bold text-gray-800">Master Website Editor</h1>
            </div>
            <nav id="sidebar-nav" class="flex-grow p-4 overflow-y-auto sidebar">
                <!-- Navigation will be dynamically generated here -->
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <header class="flex items-center justify-between h-20 bg-white border-b px-6 sticky top-0 z-20 flex-shrink-0">
                <h2 id="main-content-title" class="text-2xl font-semibold text-gray-800 truncate"></h2>
                <button id="master-save-btn" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700 transition-colors flex items-center shadow-sm">
                    <i data-feather="copy" class="w-5 h-5 mr-2"></i>
                    Generate New `database.js`
                </button>
            </header>
            <main id="main-content" class="flex-1 overflow-y-auto p-6 md:p-10 bg-gray-50">
                <!-- Editor form will be rendered here -->
            </main>
        </div>
    </div>

    <!-- Modal for adding/editing list items -->
    <div id="item-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col">
            <div class="p-5 border-b flex justify-between items-center">
                 <h3 id="modal-title" class="text-xl font-bold">Edit Item</h3>
                 <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600"><i data-feather="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6 modal-body overflow-y-auto">
                <form id="modal-form" class="space-y-4"></form>
            </div>
             <div class="flex justify-end space-x-4 p-4 border-t bg-gray-50">
                <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="button" id="save-form-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <!-- Load the master database -->
    <script src="database.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATABASE CHECK ---
        // This is the crucial fix. Check if the database file loaded correctly.
        if (typeof SGC_DATA === 'undefined') {
            document.body.innerHTML = `
                <div class="p-10 text-center bg-red-100 text-red-800">
                    <h1 class="text-3xl font-bold">Fatal Error: Database Not Found</h1>
                    <p class="mt-4 text-lg">The editor cannot start because the <strong>database.js</strong> file is missing, corrupted, or failed to load.</p>
                    <p class="mt-2">Please ensure that a valid <strong>database.js</strong> file exists in the same directory as this HTML file.</p>
                </div>`;
            console.error("SGC_DATA is not defined. Make sure database.js is loaded before this script.");
            return; // Stop execution if the database isn't loaded
        }

        // --- INITIAL SETUP ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        const deepClone = (obj) => JSON.parse(JSON.stringify(obj));

        let EDITOR_DATA = deepClone(SGC_DATA);
        let currentSectionKey = 'page_about';
        let currentItemIndex = -1;
        let currentCategoryKey = '';

        const sidebarNav = $('#sidebar-nav');
        const mainContent = $('#main-content');
        const mainContentTitle = $('#main-content-title');
        const itemModal = $('#item-modal');
        const modalForm = $('#modal-form');
        const modalTitle = $('#modal-title');

        // --- DYNAMIC SIDEBAR BUILDER ---
        const buildSidebar = () => {
            const sections = {
                "Static Pages": Object.keys(EDITOR_DATA).filter(k => k.startsWith('page_')),
                "Games & Tools": Object.keys(EDITOR_DATA).filter(k => k.startsWith('game_') || k.startsWith('tool_')),
                "Data Lists": Object.keys(EDITOR_DATA).filter(k => !k.startsWith('page_') && !k.startsWith('game_') && !k.startsWith('tool_'))
            };

            let navHtml = '';
            for (const title in sections) {
                navHtml += `<h2 class="mt-4 px-4 text-sm font-semibold text-gray-500 uppercase tracking-wider">${title}</h2>`;
                sections[title].forEach(key => {
                    const name = key.replace(/^(page_|game_|tool_)/, '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    navHtml += `<a class="sidebar-link flex items-center mt-2 px-4 py-2 text-gray-700 rounded-md hover:bg-gray-200 transition-colors" href="#" data-section="${key}">${name}</a>`;
                });
            }
            sidebarNav.innerHTML = navHtml;
        };

        // --- EDITOR RENDERING ENGINE ---
        const renderEditor = (sectionKey) => {
            currentSectionKey = sectionKey;
            const sectionData = EDITOR_DATA[sectionKey];
            const sectionName = $(`.sidebar-link[data-section="${sectionKey}"]`).textContent;
            mainContentTitle.textContent = `Editing: ${sectionName}`;

            let editorHtml = '';

            // Renderer for simple objects (static pages)
            if (typeof sectionData === 'object' && !Array.isArray(sectionData) && !Object.values(sectionData).some(v => typeof v === 'object')) {
                editorHtml = '<form id="page-form" class="bg-white p-8 rounded-lg shadow-md space-y-6">';
                for (const key in sectionData) {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const value = sectionData[key];
                    editorHtml += `<div><label class="block font-semibold text-gray-700 mb-1">${label}</label>`;
                    if (String(value).includes('\n')) {
                        editorHtml += `<textarea data-key="${key}" class="w-full p-2 border rounded-md shadow-sm">${value}</textarea>`;
                    } else {
                        editorHtml += `<input type="text" data-key="${key}" class="w-full p-2 border rounded-md shadow-sm" value="${value}">`;
                    }
                    editorHtml += `</div>`;
                }
                editorHtml += '</form>';
            }
            // Renderer for arrays of objects (simple lists)
            else if (Array.isArray(sectionData)) {
                editorHtml = renderListEditor(sectionKey, sectionData);
            }
            // Renderer for objects containing arrays (categorized lists)
            else if (typeof sectionData === 'object' && !Array.isArray(sectionData)) {
                 editorHtml = renderComplexObjectEditor(sectionKey, sectionData);
            }

            mainContent.innerHTML = editorHtml;
            feather.replace();

            // Update sidebar active state
            $$('.sidebar-link').forEach(l => l.classList.remove('active'));
            $(`.sidebar-link[data-section="${sectionKey}"]`).classList.add('active');
        };
        
        const renderListEditor = (sectionKey, data) => {
            let html = `<div class="text-right mb-4"><button class="btn-add bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 flex items-center ml-auto" data-section="${sectionKey}"><i data-feather="plus" class="w-5 h-5 mr-2"></i>Add New Item</button></div>`;
            if(data.length === 0) {
                html += `<div class="bg-white p-8 rounded-lg shadow-md text-center text-gray-500">No items yet. Click 'Add New Item' to begin.</div>`;
                return html;
            }
            html += `<div class="bg-white p-6 rounded-lg shadow-md"><table class="w-full text-left"><thead><tr>`;
            const headers = Object.keys(data[0] || {});
            headers.forEach(h => html += `<th class="p-3 bg-gray-50">${h.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`);
            html += `<th class="p-3 bg-gray-50 text-right">Actions</th></tr></thead><tbody>`;
            data.forEach((item, index) => {
                html += `<tr class="border-t"><td class="p-3 align-top">${headers.map(h => `<div class="py-1">${item[h]}</div>`).join('')}</td>`;
                html += `<td class="p-3 text-right align-top space-x-2 whitespace-nowrap">
                            <button class="btn-edit text-blue-600 hover:underline" data-section="${sectionKey}" data-index="${index}">Edit</button>
                            <button class="btn-delete text-red-600 hover:underline" data-section="${sectionKey}" data-index="${index}">Delete</button>
                         </td></tr>`;
            });
            html += `</tbody></table></div>`;
            return html;
        };

        const renderComplexObjectEditor = (sectionKey, data) => {
            let html = '<form id="page-form" class="bg-white p-8 rounded-lg shadow-md space-y-8">';
            for(const key in data){
                const value = data[key];
                const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                html += `<div><label class="block text-lg font-bold text-gray-800 mb-2 border-b pb-1">${label}</label>`;

                if(Array.isArray(value)){
                     html += `<div class="text-sm text-gray-600 mb-2">This is a list of items. Edit the raw JSON below or use the buttons to manage items.</div>`;
                     html += `<div class="text-right mb-2"><button type="button" class="btn-add bg-blue-600 text-white font-bold py-1 px-3 text-sm rounded-lg hover:bg-blue-700" data-section="${sectionKey}" data-category="${key}">Add Item to ${label}</button></div>`;
                     html += `<textarea data-key="${key}" class="w-full p-2 border rounded-md shadow-sm font-mono text-sm" rows="10">${JSON.stringify(value, null, 2)}</textarea>`;
                } else if (typeof value === 'object'){
                     html += `<div class="text-sm text-gray-600 mb-2">This is a categorized list. Edit the raw JSON below.</div>`;
                     html += `<textarea data-key="${key}" class="w-full p-2 border rounded-md shadow-sm font-mono text-sm" rows="10">${JSON.stringify(value, null, 2)}</textarea>`;
                }
                else {
                    if (String(value).includes('\n')) {
                        html += `<textarea data-key="${key}" class="w-full p-2 border rounded-md shadow-sm">${value}</textarea>`;
                    } else {
                        html += `<input type="text" data-key="${key}" class="w-full p-2 border rounded-md shadow-sm" value="${value}">`;
                    }
                }
                html += `</div>`;
            }
            html += '</form>';
            return html;
        };

        // --- MODAL & FORM LOGIC ---
        const openModal = (sectionKey, index, categoryKey = '') => {
            currentSectionKey = sectionKey;
            currentItemIndex = index;
            currentCategoryKey = categoryKey;
            const isNew = index === -1;
            
            let itemData = {};
            // Determine the object structure for the form
            if (categoryKey) { // Item within a category (e.g., glossary.haematology)
                const list = EDITOR_DATA[sectionKey][categoryKey];
                itemData = isNew ? (list[0] ? Object.fromEntries(Object.keys(list[0]).map(k => [k, ''])) : {note: "Add first item structure"}) : list[index];
            } else { // Item in a direct list (e.g., members)
                const list = EDITOR_DATA[sectionKey];
                itemData = isNew ? (list[0] ? Object.fromEntries(Object.keys(list[0]).map(k => [k, ''])) : {note: "Add first item structure"}) : list[index];
            }
            
            modalTitle.textContent = isNew ? 'Add New Item' : 'Edit Item';
            let formHtml = '';
            for (const key in itemData) {
                const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const value = itemData[key];
                formHtml += `<div><label class="block font-semibold text-gray-700 mb-1">${label}</label>`;
                if (String(value).length > 80 || String(value).includes('\n')) {
                    formHtml += `<textarea id="modal-form-${key}" class="w-full p-2 border rounded-md">${value}</textarea>`;
                } else {
                    formHtml += `<input type="text" id="modal-form-${key}" class="w-full p-2 border rounded-md" value="${value}">`;
                }
                formHtml += `</div>`;
            }
            modalForm.innerHTML = formHtml;
            itemModal.classList.remove('hidden');
        };

        const closeModal = () => itemModal.classList.add('hidden');

        const saveModalForm = () => {
            const updatedItem = {};
            modalForm.querySelectorAll('input, textarea').forEach(input => {
                const key = input.id.replace('modal-form-', '');
                updatedItem[key] = input.value;
            });

            let targetList;
            if (currentCategoryKey) {
                targetList = EDITOR_DATA[currentSectionKey][currentCategoryKey];
            } else {
                targetList = EDITOR_DATA[currentSectionKey];
            }

            if (currentItemIndex === -1) { // Add new
                targetList.push(updatedItem);
            } else { // Update existing
                targetList[currentItemIndex] = updatedItem;
            }
            
            closeModal();
            renderEditor(currentSectionKey);
        };
        
        const deleteListItem = (sectionKey, index, categoryKey = '') => {
            if(!confirm('Are you sure you want to delete this item? This cannot be undone.')) return;
            
            if (categoryKey) {
                EDITOR_DATA[sectionKey][categoryKey].splice(index, 1);
            } else {
                EDITOR_DATA[sectionKey].splice(index, 1);
            }
            renderEditor(sectionKey);
        };

        // --- DATA SAVING ---
        const saveCurrentForm = () => {
            const form = $('#page-form');
            if (!form) return; // Not a page form, nothing to save this way

            form.querySelectorAll('input, textarea').forEach(input => {
                const key = input.dataset.key;
                const isJson = input.classList.contains('font-mono');
                
                if(isJson){
                    try {
                        EDITOR_DATA[currentSectionKey][key] = JSON.parse(input.value);
                    } catch(e) {
                        alert(`Error: Invalid JSON in '${key}' field. Changes for this field were not saved. Please correct it and save again.\n\n${e.message}`);
                    }
                } else {
                    EDITOR_DATA[currentSectionKey][key] = input.value;
                }
            });
        };

        // --- EVENT LISTENERS ---
        sidebarNav.addEventListener('click', e => {
            const link = e.target.closest('.sidebar-link');
            if (link && link.dataset.section !== currentSectionKey) {
                e.preventDefault();
                saveCurrentForm();
                renderEditor(link.dataset.section);
            }
        });

        mainContent.addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const { section, index, category } = button.dataset;

            if (button.classList.contains('btn-add')) {
                openModal(section, -1, category);
            } else if (button.classList.contains('btn-edit')) {
                openModal(section, parseInt(index), category);
            } else if (button.classList.contains('btn-delete')) {
                deleteListItem(section, parseInt(index), category);
            }
        });

        $('#save-form-btn').addEventListener('click', saveModalForm);
        $('#cancel-btn').addEventListener('click', closeModal);
        $('#close-modal-btn').addEventListener('click', closeModal);

        $('#master-save-btn').addEventListener('click', () => {
            saveCurrentForm(); // Save any pending changes on the current page
            const fullFileContent = `const SGC_DATA = ${JSON.stringify(EDITOR_DATA, null, 4)};`;
            navigator.clipboard.writeText(fullFileContent).then(() => {
                alert('Success!\n\nThe new `database.js` content has been copied to your clipboard.\n\nOpen the `database.js` file in your project, delete all its content, and paste.');
            }).catch(err => alert('Failed to copy content. Your browser might not support this feature or it was blocked.'));
        });

        // --- INITIAL LOAD ---
        buildSidebar();
        renderEditor(currentSectionKey);
        feather.replace();
    });
    </script>
</body>
</html>
