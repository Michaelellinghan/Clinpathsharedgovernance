<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morphology Case HPP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nhs-blue { background-color: #005EB8; }
        .nhs-dark-blue { background-color: #003087; }
        .nhs-text-blue { color: #005EB8; }
        .nhs-text-dark-blue { color: #003087; }
        .results-table { font-size: 0.9rem; }
        .results-table td { padding: 0.25rem 0.5rem; border-bottom: 1px solid #e5e7eb; }
        .results-table tr:last-child td { border-bottom: none; }
        .feature-checkbox:disabled { opacity: 0.7; }
        .feature-label:has(.feature-checkbox:disabled) { cursor: not-allowed; color: #6b7280; }
        .highlight-correct { background-color: #dcfce7; color: #166534; }
        .highlight-abnormal { background-color: #fee2e2; }
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal-content { margin: auto; display: block; max-width: 85%; max-height: 85%; transition: transform 0.2s ease; cursor: zoom-in; }
        .modal-content.zoomed { transform: scale(2); cursor: zoom-out; }
        .modal-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
        .modal-nav { cursor: pointer; position: absolute; top: 50%; width: auto; padding: 16px; margin-top: -22px; color: white; font-weight: bold; font-size: 20px; transition: 0.3s ease; user-select: none; background-color: rgba(0,0,0,0.3); }
        .modal-nav:hover { background-color: rgba(0,0,0,0.8); }
        .modal-prev { left: 0; border-radius: 0 3px 3px 0; }
        .modal-next { right: 0; border-radius: 3px 0 0 3px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

        <div id="header-placeholder"></div>

    <main class="py-16">
        <div class="container mx-auto px-6 max-w-7xl">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold nhs-text-dark-blue">Morphology Case Library</h2>
                <p class="text-lg text-gray-600">Case Study: HPP_Case_Number</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-semibold nhs-text-dark-blue border-b pb-2 mb-4">Case Information</h3>
                        <div id="initial-info">
                             <h4 class="font-bold mt-4">Full Blood Count</h4>
                            <table class="w-full results-table mt-2">
                                <tr><td>WBC</td><td class="font-mono text-right">x.xx x10⁹/L</td></tr>
                                <tr id="rbc-row"><td>RBC</td><td class="font-mono text-right">x.xx x10¹²/L</td></tr>
                                <tr><td>HGB</td><td class="font-mono text-right">xxx g/L</td></tr>
                                <tr id="hct-row"><td>HCT</td><td class="font-mono text-right">x.xxx L/L</td></tr>
                                <tr><td>MCV</td><td class="font-mono text-right">xx.x fL</td></tr>
                                <tr><td>MCH</td><td class="font-mono text-right">xx.x pg</td></tr>
                                <tr id="mchc-row"><td>MCHC</td><td class="font-mono text-right">xxx g/L</td></tr>
                                <tr><td>PLT</td><td class="font-mono text-right">xxx x10⁹/L</td></tr>
                                <tr><td>MPV</td><td class="font-mono text-right">xx.x fL</td></tr>
                                <tr id="rdw-row"><td>RDW-CV</td><td class="font-mono text-right">xx.x %</td></tr>
                                <tr><td>NRBC</td><td class="font-mono text-right">x.xx x10⁹/L</td></tr>
                                <tr id="retic-row"><td>Reticulocyte</td><td class="font-mono text-right">xxx.xx x10⁹/L</td></tr>
                            </table>
                             <h4 class="font-bold mt-4">Automated Differential</h4>
                             <table class="w-full results-table mt-2">
                                <tr><td>Neutrophils</td><td class="font-mono text-right">x.xx x10⁹/L (xx.x%)</td></tr>
                                <tr><td>Lymphocytes</td><td class="font-mono text-right">x.xx x10⁹/L (xx.x%)</td></tr>
                                <tr><td>Monocytes</td><td class="font-mono text-right">x.xx x10⁹/L (x.x%)</td></tr>
                                <tr><td>Eosinophils</td><td class="font-mono text-right">x.xx x10⁹/L (x.x%)</td></tr>
                                <tr><td>Basophils</td><td class="font-mono text-right">x.xx x10⁹/L (x.x%)</td></tr>
                            </table>
                        </div>
                        <div id="full-case-details" class="hidden mt-4 pt-4 border-t">
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-semibold nhs-text-dark-blue border-b pb-2 mb-4">Blood Film Examination</h3>
                        <div class="mb-6">
                            <h4 class="font-semibold text-lg">Red Cell Picture</h4>
                            <div id="red-cell-container" class="cursor-pointer">
                                <img id="red-cell-img" src="morphology/HPP/HPP Red Cells.JPG" alt="Overall red cell picture for case" class="rounded-md w-full h-auto mt-2 shadow">
                            </div>
                        </div>
                        <div>
                             <h4 class="font-semibold text-lg">White Cell Gallery</h4>
                             <p class="text-sm text-gray-600 mb-2">Click a thumbnail to view the full-size image.</p>
                             <div id="wbc-gallery" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 max-h-96 overflow-y-auto pr-2">
                                 </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-2xl font-semibold nhs-text-dark-blue border-b pb-2 mb-4">Morphology Checklist</h3>
                    <p class="text-gray-600 mb-4">Select up to three key morphological features you have identified.</p>
                    
                    <div id="feature-checklist" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        </div>

                    <button id="reveal-btn" onclick="checkMorphology()" class="w-full mt-6 bg-black text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 transition duration-300">See Results</button>
                    
                    <div id="results" class="mt-4"></div>

                    <div id="analysis-section" class="hidden mt-6 border-t pt-6">
                        <h3 class="text-2xl font-semibold nhs-text-dark-blue mb-4">Analysis & Peer Consensus</h3>
                        
                        <div class="mb-6">
                            <h4 class="text-lg font-bold">Your Selected Features:</h4>
                            <ul id="user-choices" class="list-disc list-inside mt-2"></ul>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="text-lg font-bold">Expert Commentary</h4>
                            <div class="mt-2 p-4 bg-gray-100 rounded-md text-gray-700">
                                <p id="expert-comment-text" class="whitespace-pre-wrap"></p>
                            </div>
                        </div>

                        <div>
                            <h4 class="text-lg font-bold">Top Features</h4>
                            <table class="w-full text-left mt-2 text-sm">
                                <thead>
                                    <tr class="bg-gray-50"><th class="p-2">Feature</th><th
                                </thead>
                                <tbody id="top-features-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                                        <section class="text-center mt-12">
                <a href="morphology_cases.html" class="bg-gray-800 text-white font-bold py-3 px-8 rounded-full hover:bg-gray-700 transition duration-300">
                    <i class="fas fa-arrow-left mr-2"></i>Back to More Cases
                </a>
            </section>
    </main>

    <div id="image-modal" class="modal">
        <span class="modal-close" id="modal-close-btn">&times;</span>
        <a class="modal-prev modal-nav" id="modal-prev-btn">&#10094;</a>
        <a class="modal-next modal-nav" id="modal-next-btn">&#10095;</a>
        <img class="modal-content" id="modal-img">
    </div>

    <div id="footer-placeholder"></div>

      <script src="js/component-loader.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
        });
   </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Initialise Feather Icons ---
            feather.replace();

            // --- Page Data for Case ---
            const imageFilenames = ["ART_1069380.jpg", "BA_1069298.jpg", "BA_1069312.jpg", "BA_1069413.jpg", "BNE_1069287.jpg", "BNE_1069317.jpg", "BNE_1069337.jpg", "BNE_1069350.jpg", "BNE_1069353.jpg", "BNE_1069359.jpg", "BNE_1069382.jpg", "BNE_1069387.jpg", "BNE_1069404.jpg", "BNE_1069468.jpg", "BNE_1069475.jpg", "BNE_1069482.jpg", "BNE_1069497.jpg", "EO_1069361.jpg", "EO_1069401.jpg", "EO_1069430.jpg", "EO_1069460.jpg", "EO_1069467.jpg", "GT_1069295.jpg", "GT_1069320.jpg", "GT_1069325.jpg", "LY_1069284.jpg", "LY_1069288.jpg", "LY_1069291.jpg", "LY_1069292.jpg", "LY_1069293.jpg", "LY_1069297.jpg", "LY_1069300.jpg", "LY_1069302.jpg", "LY_1069303.jpg", "LY_1069308.jpg", "LY_1069309.jpg", "LY_1069310.jpg", "LY_1069311.jpg", "LY_1069316.jpg", "LY_1069326.jpg", "LY_1069328.jpg", "LY_1069329.jpg", "LY_1069330.jpg", "LY_1069333.jpg", "LY_1069334.jpg", "LY_1069335.jpg", "LY_1069336.jpg", "LY_1069343.jpg", "LY_1069344.jpg", "LY_1069346.jpg", "LY_1069347.jpg", "LY_1069357.jpg", "LY_1069358.jpg", "LY_1069360.jpg", "LY_1069365.jpg", "LY_1069371.jpg", "LY_1069372.jpg", "LY_1069374.jpg", "LY_1069379.jpg", "LY_1069381.jpg", "LY_1069383.jpg", "LY_1069385.jpg", "LY_1069386.jpg", "LY_1069388.jpg", "LY_1069389.jpg", "LY_1069390.jpg", "LY_1069393.jpg", "LY_1069395.jpg", "LY_1069396.jpg", "LY_1069398.jpg", "LY_1069403.jpg", "LY_1069407.jpg", "LY_1069410.jpg", "LY_1069411.jpg", "LY_1069412.jpg", "LY_1069416.jpg", "LY_1069417.jpg", "LY_1069424.jpg", "LY_1069427.jpg", "LY_1069428.jpg", "LY_1069439.jpg", "LY_1069445.jpg", "LY_1069448.jpg", "LY_1069452.jpg", "LY_1069454.jpg", "LY_1069456.jpg", "LY_1069463.jpg", "LY_1069466.jpg", "LY_1069471.jpg", "LY_1069478.jpg", "LY_1069483.jpg", "LY_1069486.jpg", "LY_1069487.jpg", "LY_1069490.jpg", "LY_1069491.jpg", "MMY_1069477.jpg", "MO_1069286.jpg", "MO_1069289.jpg", "MO_1069306.jpg", "MO_1069313.jpg", "MO_1069323.jpg", "MO_1069351.jpg", "MO_1069433.jpg", "MO_1069435.jpg", "MO_1069458.jpg", "MO_1069461.jpg", "MO_1069469.jpg", "MO_1069481.jpg", "MO_1069495.jpg", "MO_1069496.jpg", "MY_1069444.jpg", "SMU_1069296.jpg", "SMU_1069301.jpg", "SMU_1069349.jpg", "SMU_1069394.jpg", "SMU_1069406.jpg", "SMU_1069425.jpg", "SMU_1069473.jpg", "SMU_1069474.jpg", "SMU_1069480.jpg", "SNE_1069283.jpg", "SNE_1069290.jpg", "SNE_1069294.jpg", "SNE_1069299.jpg", "SNE_1069304.jpg", "SNE_1069305.jpg", "SNE_1069307.jpg", "SNE_1069314.jpg", "SNE_1069315.jpg", "SNE_1069318.jpg", "SNE_1069319.jpg", "SNE_1069321.jpg", "SNE_1069322.jpg", "SNE_1069324.jpg", "SNE_1069331.jpg", "SNE_1069332.jpg", "SNE_1069338.jpg", "SNE_1069339.jpg", "SNE_1069340.jpg", "SNE_1069341.jpg", "SNE_1069342.jpg", "SNE_1069345.jpg", "SNE_1069348.jpg", "SNE_1069354.jpg", "SNE_1069355.jpg", "SNE_1069356.jpg", "SNE_1069362.jpg", "SNE_1069364.jpg", "SNE_1069366.jpg", "SNE_1069367.jpg", "SNE_1069368.jpg", "SNE_1069369.jpg", "SNE_1069370.jpg", "SNE_1069373.jpg", "SNE_1069375.jpg", "SNE_1069376.jpg", "SNE_1069378.jpg", "SNE_1069384.jpg", "SNE_1069391.jpg", "SNE_1069392.jpg", "SNE_1069397.jpg", "SNE_1069399.jpg", "SNE_1069400.jpg", "SNE_1069402.jpg", "SNE_1069405.jpg", "SNE_1069408.jpg", "SNE_1069409.jpg", "SNE_1069414.jpg", "SNE_1069415.jpg", "SNE_1069418.jpg", "SNE_1069419.jpg", "SNE_1069420.jpg", "SNE_1069421.jpg", "SNE_1069422.jpg", "SNE_1069423.jpg", "SNE_1069426.jpg", "SNE_1069429.jpg", "SNE_1069431.jpg", "SNE_1069432.jpg"];

            const expertComment = "Enter expert commentary here.";
            
            const topPeerFeatures = [
                {"feature":"Feature 1"},
                {"feature":"Feature 2"},
                {"feature":"Feature 3"},
            ];

            const morphologyFeatures = {"Red Cell Features":["Anaemia","Microcytes","Hypochromic Cells","Polychromatic Cells","Mixed Cell Population (Dimorphic)","Poikilocytes","Target Cells","Echinocytes/Crenated Cells","Fragments/Schistocytes","Sickle Cells","Spherocytes","Rouleaux","Basophilic Stippling","Nucleated RBCs","Acanthocytes","Tear Drop Poikilocytes","Keratocytes/Bite Cells","Boat-shaped Cells","Howell-Jolly Bodies", "Elliptocytes"],"White Cell Features":["Leukocytosis","Eosinophilia","Band Form Neutrophils","Toxic Granulation","Hypogranular/Agranular Cytoplasm (Neutrophils)","Blast Cells","Promyelocytes","Prolymphocytes","Myelocytes","Smear/Smudge Cells","Atypical/Suspect Reactive Lymphocytes","Reactive/Plasmacytoid Lymphocytes","Cleft Nuclei","Plasma Cells","Auer Rods","Basophilia","Neutropenia","Lymphocytosis","Lymphopenia","Abnormal/Suspect Neoplastic Lymphocytes","Large Granular Lymphocytes","Left Shift","Pseudo-Pelger Cells","Promonocytes"],"Platelet Features":["Thrombocytosis","Thrombocytopenia","Large/Giant Platelets","Platelet Anisocytosis","Platelet Clumps"]};
            
            // --- UI Element References ---
            const checklistContainer = document.getElementById('feature-checklist');
            const galleryContainer = document.getElementById('wbc-gallery');
            const revealBtn = document.getElementById('reveal-btn');
            const analysisSection = document.getElementById('analysis-section');
            const fullDetailsSection = document.getElementById('full-case-details');
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-img');
            const closeModalBtn = document.getElementById('modal-close-btn');
            const prevBtn = document.getElementById('modal-prev-btn');
            const nextBtn = document.getElementById('modal-next-btn');
            const redCellContainer = document.getElementById('red-cell-container');

            let currentImageIndex = 0;
            const imagePath = 'morphology/HPP/';
            const allGalleryImages = [document.getElementById('red-cell-img').src, ...imageFilenames.map(name => imagePath + name)];

            // --- UI Population ---
            for (const category in morphologyFeatures) {
                let categoryHtml = `<h4 class="font-bold mt-4 text-gray-700">${category}</h4>`;
                morphologyFeatures[category].forEach(feature => {
                    categoryHtml += `<label class="feature-label flex items-center space-x-3 cursor-pointer"><input type="checkbox" value="${feature}" class="feature-checkbox h-5 w-5 rounded border-gray-300 text-nhs-blue focus:ring-nhs-blue" data-feature="${feature}"><span>${feature}</span></label>`;
                });
                checklistContainer.innerHTML += categoryHtml;
            }


            imageFilenames.forEach(filename => {
                const img = document.createElement('img');
                img.src = imagePath + filename;
                img.alt = `Morphology image: ${filename}`;
                img.className = 'w-full h-auto rounded cursor-pointer hover:opacity-75 transition-opacity';
                galleryContainer.appendChild(img);
            });
            
            // --- Event Logic ---
            const openModal = (startIndex) => {
                currentImageIndex = startIndex;
                modal.style.display = "flex";
                modalImg.src = allGalleryImages[currentImageIndex];
                modalImg.classList.remove('zoomed');
            };

            const showImage = (newIndex) => {
                currentImageIndex = (newIndex + allGalleryImages.length) % allGalleryImages.length;
                modalImg.src = allGalleryImages[currentImageIndex];
                modalImg.classList.remove('zoomed');
            };
            
            redCellContainer.addEventListener('click', () => openModal(0));
            
            Array.from(galleryContainer.children).forEach((thumb, index) => {
                thumb.addEventListener('click', () => openModal(index + 1)); 
            });

            prevBtn.addEventListener('click', (e) => { e.stopPropagation(); showImage(currentImageIndex - 1); });
            nextBtn.addEventListener('click', (e) => { e.stopPropagation(); showImage(currentImageIndex + 1); });
            closeModalBtn.onclick = () => { modal.style.display = "none"; };
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = "none"; });
            modalImg.addEventListener('click', (e) => { e.stopPropagation(); e.target.classList.toggle('zoomed'); });

            checklistContainer.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    if (document.querySelectorAll('.feature-checkbox:checked').length > 3) {
                        e.target.checked = false;
                        alert('You can select a maximum of three features.');
                    }
                }
            });
        });

        function checkMorphology() {
            const correctFeatures = ["Poikilocytes", "Fragments/Schistocytes", "Elliptocytes"];
            const checkboxes = document.querySelectorAll('#feature-checklist input[type="checkbox"]:checked');
            const selectedFeatures = Array.from(checkboxes).map(cb => cb.value);
            const resultContainer = document.getElementById('results');

            let score = 0;
            let correctSelections = [];
            let incorrectSelections = [];

            // Check selected features against the correct list
            selectedFeatures.forEach(feature => {
                if (correctFeatures.includes(feature)) {
                    score++;
                    correctSelections.push(feature);
                } else {
                    incorrectSelections.push(feature);
                }
            });

            const missedFeatures = correctFeatures.filter(f => !selectedFeatures.includes(f));

            let resultHTML = `<h3>Results</h3>`;
            resultHTML += `<p>You correctly identified ${correctSelections.length} out of 3 features.</p>`;

            if (correctSelections.length > 0) {
                resultHTML += `<p><strong>Correctly identified:</strong> ${correctSelections.join(', ')}</p>`;
            }
            if (incorrectSelections.length > 0) {
                resultHTML += `<p><strong>Incorrectly identified:</strong> ${incorrectSelections.join(', ')}</p>`;
            }
            if (missedFeatures.length > 0) {
                resultHTML += `<p><strong>Missed features:</strong> ${missedFeatures.join(', ')}</p>`;
            }

            // Display final score and feedback
            if (score === 3 && selectedFeatures.length === 3) {
                resultHTML += `<p style="color: green;"><strong>Excellent! You identified all the key morphological features.</strong></p>`;
            } else {
                resultHTML += `<p style="color: orange;"><strong>You're on the right track! Review the missed or incorrectly identified features and try again.</strong></p>`;
            }

            resultContainer.innerHTML = resultHTML;

            // Also reveal the analysis section
            document.getElementById('analysis-section').classList.remove('hidden');
            document.getElementById('full-case-details').classList.remove('hidden');
            document.getElementById('reveal-btn').disabled = true;
            document.getElementById('reveal-btn').classList.add('opacity-50', 'cursor-not-allowed');
            document.querySelectorAll('.feature-checkbox').forEach(cb => cb.disabled = true);
            document.getElementById('user-choices').innerHTML = selectedFeatures.length > 0 ? selectedFeatures.map(choice => `<li>${choice}</li>`).join('') : '<li>No features selected.</li>';
            document.getElementById('expert-comment-text').textContent = "Enter expert commentary here.";
            
            const topFeaturesTable = document.getElementById('top-features-table');
            const topPeerFeatures = [
                {"feature":"Poikilocytes"},
                {"feature":"Fragments/Schistocytes"},
                {"feature":"Elliptocytes"},
            ];
            topFeaturesTable.innerHTML = topPeerFeatures.map(f => {
                const isUserChoice = selectedFeatures.includes(f.feature);
                return `<tr class="${isUserChoice ? 'highlight-correct font-bold' : ''}"><td class="p-2">${f.feature}</td></tr>`;
            }).join('');

            // Highlight abnormal results (add relevant row IDs)
            // Example:
            // document.getElementById('rbc-row').classList.add('highlight-abnormal');
        }

    </script>

</body>
</html>
