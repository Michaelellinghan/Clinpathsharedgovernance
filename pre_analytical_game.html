<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-analytical Pitfalls - SGC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nhs-blue { background-color: #005EB8; }
        .nhs-dark-blue { background-color: #003087; }
        .nhs-light-grey { background-color: #F0F4F5; }
        .nhs-text-blue { color: #005EB8; }
        .nhs-text-dark-blue { color: #003087; }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Style for the option buttons */
        .option-btn {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">

    <!-- This div will be populated by js/component-loader.js -->
    <div id="header-placeholder"></div>

    <main class="py-12 md:py-16 bg-nhs-light-grey flex-grow">
        <div class="container mx-auto px-4 sm:px-6 max-w-3xl text-center">
            <a href="games.html" class="inline-flex items-center nhs-text-blue font-semibold mb-8 hover:underline">
                <i data-feather="arrow-left" class="w-4 h-4 mr-2"></i>Back to Games
            </a>
            <h2 class="text-3xl md:text-4xl font-bold nhs-text-dark-blue mb-4">Pre-analytical Pitfalls</h2>
            <p class="text-gray-600 mb-8 max-w-2xl mx-auto">Identify common errors in sample collection and handling, and understand their impact on test results.</p>

            <!-- The main quiz container. It starts hidden and is shown by the script. -->
            <div id="quiz-container" class="bg-white p-6 md:p-8 rounded-lg shadow-lg text-left hidden">
                <p id="question-text" class="text-xl font-medium mb-6"></p>
                <div id="options-container" class="space-y-4">
                    <!-- Options will be populated by JS -->
                </div>
                <div id="feedback-container" class="mt-6 p-4 rounded-lg hidden">
                    <p id="feedback-text" class="font-semibold"></p>
                </div>
                <div class="text-right">
                    <button id="next-question-btn" class="mt-6 bg-gray-800 text-white font-bold py-3 px-8 rounded-lg hover:bg-black transition duration-300 hidden">Next Question</button>
                </div>
            </div>

            <!-- The game over screen. Also starts hidden. -->
            <div id="game-over-screen" class="hidden bg-white p-8 rounded-lg shadow-lg mt-8 fade-in">
                <h3 class="text-2xl font-bold nhs-text-dark-blue mb-4">Quiz Complete!</h3>
                <p id="final-score" class="text-xl text-gray-700 mb-6"></p>
                <button id="play-again-btn" class="bg-nhs-blue text-white font-bold py-3 px-8 rounded-lg hover:bg-nhs-dark-blue transition duration-300">Play Again</button>
            </div>
        </div>
    </main>

    <!-- This div will be populated by js/component-loader.js -->
    <div id="footer-placeholder"></div>
    
    <!-- This script loads the header and footer. Make sure the path is correct. -->
    <script src="js/component-loader.js"></script>
    
    <!-- This is the main script for the game itself. -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Initialise Feather Icons ---
            // This renders icons present in the initial HTML (like the 'Back to Games' arrow).
            // The component-loader.js will separately call this for icons in the header/footer.
            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            // --- DOM Element References ---
            const questionTextEl = document.getElementById('question-text');
            const optionsContainerEl = document.getElementById('options-container');
            const feedbackContainerEl = document.getElementById('feedback-container');
            const feedbackTextEl = document.getElementById('feedback-text');
            const nextQuestionBtn = document.getElementById('next-question-btn');
            const quizContainerEl = document.getElementById('quiz-container');
            const gameOverScreenEl = document.getElementById('game-over-screen');
            const finalScoreEl = document.getElementById('final-score');
            const playAgainBtn = document.getElementById('play-again-btn');

            // --- Game State ---
            let currentQuestionIndex = 0;
            let score = 0;
            let questions = [];

            // --- Game Data ---
            const allQuestions = [
                {
                    question: "A blood sample for **Potassium** measurement was left at room temperature for 8 hours before being centrifuged. The result is likely to be...",
                    options: [
                        { text: "Falsely low due to cell metabolism.", isCorrect: false },
                        { text: "Falsely high due to potassium leakage from red blood cells.", isCorrect: true },
                        { text: "Unaffected, as potassium is stable.", isCorrect: false },
                        { text: "Inconclusive due to clot formation.", isCorrect: false }
                    ],
                    explanation: "Prolonged contact of serum/plasma with red blood cells allows potassium to leak out, causing a falsely elevated result. This is a common pre-analytical error."
                },
                {
                    question: "A **coagulation** sample (e.g., for PT/APTT) is collected into a tube that is underfilled. What is the likely impact on results?",
                    options: [
                        { text: "Clotting times will be falsely shortened.", isCorrect: false },
                        { text: "Clotting times will be falsely prolonged.", isCorrect: true },
                        { text: "The sample will haemolyse.", isCorrect: false },
                        { text: "There will be no significant impact.", isCorrect: false }
                    ],
                    explanation: "The fixed amount of citrate anticoagulant is too high for the blood volume, leading to excess binding of calcium and falsely prolonged clotting times."
                },
                {
                    question: "A **bilirubin** sample is exposed to direct sunlight for an extended period. What effect is this likely to have on the result?",
                    options: [
                        { text: "Falsely increased due to light activation.", isCorrect: false },
                        { text: "Falsely decreased due to photodegradation.", isCorrect: true },
                        { text: "No significant effect, bilirubin is stable.", isCorrect: false },
                        { text: "It will cause the sample to clot.", isCorrect: false }
                    ],
                    explanation: "Bilirubin is light-sensitive and breaks down upon exposure to UV light, leading to a falsely decreased result. Samples should be protected from light."
                },
                {
                    question: "A blood sample for **Sodium** is found to be lipemic (high fats). Using an indirect ISE method, what is the likely impact?",
                    options: [
                        { text: "Falsely high sodium due to interference.", isCorrect: false },
                        { text: "Falsely low sodium (pseudohyponatremia).", isCorrect: true },
                        { text: "No effect on sodium.", isCorrect: false },
                        { text: "The sample will clot prematurely.", isCorrect: false }
                    ],
                    explanation: "High lipid content displaces the aqueous portion of the sample. Since sodium is in the aqueous phase, its measured concentration appears lower than it actually is."
                },
                {
                    question: "A patient's blood sample is collected with **prolonged tourniquet application** (over 3 minutes). Which analytes are most likely to be falsely elevated?",
                    options: [
                        { text: "Glucose and Urea.", isCorrect: false },
                        { text: "Total Protein, Albumin, and Calcium.", isCorrect: true },
                        { text: "Sodium and Chloride.", isCorrect: false },
                        { text: "Creatinine and Phosphate.", isCorrect: false }
                    ],
                    explanation: "Prolonged venous stasis causes water and small molecules to leak from the vessel, concentrating larger molecules like proteins and protein-bound analytes like calcium."
                },
                {
                    question: "An EDTA (lavender top) tube is collected **before** a serum (red top) tube. What is a significant risk for the chemistry results?",
                    options: [
                        { text: "Falsely low potassium and high calcium.", isCorrect: false },
                        { text: "Falsely high potassium and falsely low calcium.", isCorrect: true },
                        { text: "Contamination with gel separator.", isCorrect: false },
                        { text: "Delayed clotting of the serum tube.", isCorrect: false }
                    ],
                    explanation: "Carryover of potassium-EDTA from the lavender tube contaminates the serum tube. EDTA binds calcium (falsely low) and the sample is contaminated with potassium (falsely high)."
                },
                {
                    question: "A patient did not fast as required before a **lipid profile** and had a fatty meal. What is the expected impact?",
                    options: [
                        { text: "Falsely low cholesterol and triglycerides.", isCorrect: false },
                        { text: "Falsely high triglycerides.", isCorrect: true },
                        { text: "No significant effect.", isCorrect: false },
                        { text: "Increased HDL cholesterol only.", isCorrect: false }
                    ],
                    explanation: "A non-fasting state, especially after a fatty meal, leads to a temporary but significant increase in circulating triglycerides, making the sample lipemic."
                },
                {
                    question: "A **blood transfusion** sample is mislabelled with another patient's details. What is the most severe potential outcome?",
                    options: [
                        { text: "Delayed test results.", isCorrect: false },
                        { text: "Minor allergic reaction.", isCorrect: false },
                        { text: "Acute haemolytic transfusion reaction.", isCorrect: true },
                        { text: "Need for a repeat venepuncture.", isCorrect: false }
                    ],
                    explanation: "This is a critical error. Transfusing incompatible blood can cause a catastrophic immune reaction, leading to massive red cell destruction, organ failure, and potentially death."
                },
                {
                    question: "A **coagulation** sample arrives at the laboratory clotted. What is the most likely reason?",
                    options: [
                        { text: "Overfilling the tube.", isCorrect: false },
                        { text: "Underfilling the tube.", isCorrect: false },
                        { text: "Insufficient or delayed mixing with anticoagulant.", isCorrect: true },
                        { text: "Exposure to cold temperature.", isCorrect: false }
                    ],
                    explanation: "The blood must be mixed gently but thoroughly with the citrate anticoagulant immediately after collection to prevent the clotting cascade from activating."
                }
            ];

            // --- Game Logic Functions ---

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function displayQuestion() {
                if (currentQuestionIndex >= questions.length) {
                    endGame();
                    return;
                }

                quizContainerEl.classList.remove('fade-in');
                void quizContainerEl.offsetWidth; // Trigger reflow
                quizContainerEl.classList.add('fade-in');

                const questionData = questions[currentQuestionIndex];
                questionTextEl.innerHTML = questionData.question;
                optionsContainerEl.innerHTML = '';
                feedbackContainerEl.classList.add('hidden');
                nextQuestionBtn.classList.add('hidden');

                const shuffledOptions = shuffleArray([...questionData.options]);
                shuffledOptions.forEach(option => {
                    const button = document.createElement('button');
                    button.innerHTML = option.text; // Use innerHTML to render bold tags
                    button.classList.add('option-btn', 'w-full', 'p-3', 'border', 'border-gray-300', 'rounded-lg', 'text-left', 'hover:bg-gray-100', 'focus:outline-none', 'focus:ring-2', 'focus:ring-nhs-blue', 'transition', 'duration-200');
                    button.dataset.isCorrect = option.isCorrect;
                    button.addEventListener('click', () => selectOption(button, questionData.explanation));
                    optionsContainerEl.appendChild(button);
                });
            }

            function selectOption(selectedButton, explanation) {
                const isCorrect = selectedButton.dataset.isCorrect === 'true';
                optionsContainerEl.querySelectorAll('button').forEach(button => {
                    button.disabled = true;
                    if (button.dataset.isCorrect === 'true') {
                        button.classList.add('bg-green-200', 'border-green-400');
                    } else if (button === selectedButton) {
                        button.classList.add('bg-red-200', 'border-red-400');
                    }
                });

                if (isCorrect) {
                    score++;
                    feedbackContainerEl.className = 'mt-6 p-4 rounded-lg bg-green-100 text-green-800 fade-in';
                    feedbackTextEl.innerHTML = `<strong>Correct!</strong> ${explanation}`;
                } else {
                    feedbackContainerEl.className = 'mt-6 p-4 rounded-lg bg-red-100 text-red-800 fade-in';
                    feedbackTextEl.innerHTML = `<strong>Incorrect.</strong> ${explanation}`;
                }
                nextQuestionBtn.classList.remove('hidden');
            }

            function nextQuestion() {
                currentQuestionIndex++;
                displayQuestion();
            }

            function endGame() {
                quizContainerEl.classList.add('hidden');
                gameOverScreenEl.classList.remove('hidden');
                finalScoreEl.textContent = `You scored ${score} out of ${questions.length}.`;
            }

            function startGame() {
                currentQuestionIndex = 0;
                score = 0;
                questions = shuffleArray([...allQuestions]);
                gameOverScreenEl.classList.add('hidden');
                quizContainerEl.classList.remove('hidden');
                displayQuestion();
            }

            // --- Event Listeners ---
            nextQuestionBtn.addEventListener('click', nextQuestion);
            playAgainBtn.addEventListener('click', startGame);

            // --- Initialisation ---
            startGame();
        });
    </script>
</body>
</html>
